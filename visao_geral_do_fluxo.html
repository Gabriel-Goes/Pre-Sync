<!doctype html>
<html class="no-js" lang="pt-BR">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Índice" href="genindex.html" /><link rel="search" title="Buscar" href="search.html" /><link rel="next" title="SYNC.sh — API/Reference" href="api/sync.html" /><link rel="prev" title="guia_operador" href="guia_operador.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>Visão geral do fluxo (SYNC.sh) - documentação SYNC - Sincronização SDS 0.1.0</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">documentação SYNC - Sincronização SDS 0.1.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Buscar" name="q" aria-label="Buscar">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="guia_rapido.html">Guia rápido</a></li>
<li class="toctree-l1"><a class="reference internal" href="guia_operador.html">guia_operador</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Visão geral do fluxo (<code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/sync.html">SYNC.sh — API/Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="_modules/SYNC.sh.html">SYNC.sh — source</a></li>
<li class="toctree-l1"><a class="reference internal" href="fluxo_reftek.html">fluxo_reftek</a></li>
<li class="toctree-l1"><a class="reference internal" href="fluxo_raspberry.html">fluxo_raspberry</a></li>
<li class="toctree-l1"><a class="reference internal" href="estrutura_diretorios.html">estrutura_diretorios</a></li>
<li class="toctree-l1"><a class="reference internal" href="flags_cli.html">flags_cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="logs_e_rastreabilidade.html">logs_e_rastreabilidade</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencias.html">dependencias</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="visao-geral-do-fluxo-sync-sh">
<h1>Visão geral do fluxo (<code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>)<a class="headerlink" href="#visao-geral-do-fluxo-sync-sh" title="Link permanente para este cabeçalho">#</a></h1>
<p>Este documento descreve <strong>o fluxo geral</strong> do script <code class="docutils literal notranslate"><span class="pre">/var/WORKTMP/SYNC/SYNC.sh</span></code> (também usado como <code class="docutils literal notranslate"><span class="pre">$HOME/TMP/SYNC/SYNC.sh</span></code>), explicando <strong>cada bloco funcional</strong> (funções, estruturas de dados, variáveis globais e o <code class="docutils literal notranslate"><span class="pre">main</span></code>) e como os dados percorrem o pipeline até publicação na estrutura <strong>SDS (SeisComP)</strong>.</p>
<blockquote>
<div><p>Convenção deste texto: quando eu cito um bloco de código, uso trechos extraídos por marcadores estáveis no <code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>.</p>
</div></blockquote>
<hr class="docutils" />
<section id="objetivo-operacional-do-script">
<h2>0) Objetivo operacional do script<a class="headerlink" href="#objetivo-operacional-do-script" title="Link permanente para este cabeçalho">#</a></h2>
<p>O <code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code> automatiza:</p>
<ol class="arabic simple">
<li><p><strong>Identificação do último dia sincronizado</strong> na SDS (<code class="docutils literal notranslate"><span class="pre">/SDS/&lt;ANO&gt;/&lt;REDE&gt;/&lt;ESTACAO&gt;/HHZ.D</span></code>).</p></li>
<li><p><strong>Seleção automática do melhor pacote</strong> (ZIP/RAR/TAR/ZIP.BZ2) em <code class="docutils literal notranslate"><span class="pre">ZIP/&lt;ESTACAO&gt;/</span></code> que contenha dados <strong>a partir</strong> do último sincronizado.</p></li>
<li><p><strong>Processamento específico por tipo de estação</strong>:</p>
<ul class="simple">
<li><p><strong>REFTEK RT130</strong>: binário → miniSEED → <code class="docutils literal notranslate"><span class="pre">dataselect</span></code> → <code class="docutils literal notranslate"><span class="pre">sdsClone.py</span></code> → <code class="docutils literal notranslate"><span class="pre">workthisout.sh</span></code>.</p></li>
<li><p><strong>Raspberry Shake</strong>: miniSEED → correções (<code class="docutils literal notranslate"><span class="pre">msmod</span></code>) → <code class="docutils literal notranslate"><span class="pre">dataselect</span></code> → <code class="docutils literal notranslate"><span class="pre">sdsClone.py</span></code> → <code class="docutils literal notranslate"><span class="pre">workthisout.sh</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Rastreabilidade e integridade</strong>: log único por execução, renomeado ao final e enriquecido com <strong>MD5</strong> e tamanhos.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="regras-globais-de-robustez-e-rastreabilidade">
<h2>1) Regras globais de robustez e rastreabilidade<a class="headerlink" href="#regras-globais-de-robustez-e-rastreabilidade" title="Link permanente para este cabeçalho">#</a></h2>
<section id="set-euo-pipefail">
<span id="sync-strict-mode"></span><h3>1.1 <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-euo</span> <span class="pre">pipefail</span></code><a class="headerlink" href="#set-euo-pipefail" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-strict-mode"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-strict-mode"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Modo estrito do shell</span><a class="headerlink" href="#id1" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</pre></div>
</div>
</div>
<p>O script impõe:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-e</span></code>: aborta ao ocorrer erro (retorno ≠ 0), exceto em construções controladas, ou seja, dentro de testes, if/elif/while/until não aborta se retornar ≠ 0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-u</span></code>: aborta se variável não definida for expandida.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">pipefail</span></code>: um erro em qualquer comando do <em>pipe</em> propaga falha.</p></li>
</ul>
<p><strong>Consequência prática:</strong> para comandos que podem falhar “controladamente”, o script encapsula em <code class="docutils literal notranslate"><span class="pre">run_cmd</span></code> (abaixo) e em alguns <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">!</span> <span class="pre">...;</span> <span class="pre">then</span></code> explícitos.</p>
</section>
<section id="run-cmd">
<span id="sync-run-cmd"></span><h3>1.2 <code class="docutils literal notranslate"><span class="pre">run_cmd()</span></code><a class="headerlink" href="#run-cmd" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-run-cmd"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-run-cmd"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Função run_cmd</span><a class="headerlink" href="#id2" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>run_cmd<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">cmd</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">status</span><span class="o">=</span><span class="nv">$?</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] [ERROR] Comando &#39;</span><span class="si">${</span><span class="nv">cmd</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&#39; retornou </span><span class="nv">$status</span><span class="s2">.&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$status</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p><strong>Finalidade:</strong> executar um comando preservando o comportamento do <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-e</span></code>, mas registrando erro no log com timestamp.</p>
<ul class="simple">
<li><p>Entrada: <code class="docutils literal notranslate"><span class="pre">run_cmd</span> <span class="pre">&lt;cmd&gt;</span> <span class="pre">&lt;args...&gt;</span></code></p></li>
<li><p>Saída:</p>
<ul>
<li><p>retorna <code class="docutils literal notranslate"><span class="pre">0</span></code> se sucesso;</p></li>
<li><p>retorna o código original se falha, e registra:</p>
<ul>
<li><p>timestamp</p></li>
<li><p>comando completo</p></li>
<li><p>status</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Ponto importante:</strong> <code class="docutils literal notranslate"><span class="pre">run_cmd</span></code> escreve em <code class="docutils literal notranslate"><span class="pre">$log_file</span></code>. O arquivo é definido mais tarde no bloco “CONFIG + MAIN”, mas isso é válido porque a função só é <strong>executada</strong> após a configuração.</p>
</section>
</section>
<hr class="docutils" />
<section id="inventario-estatico-estacoes-das-codes-e-projetos">
<h2>2) Inventário estático: estações, DAS codes e projetos<a class="headerlink" href="#inventario-estatico-estacoes-das-codes-e-projetos" title="Link permanente para este cabeçalho">#</a></h2>
<section id="listas-por-tipo">
<span id="sync-station-lists"></span><h3>2.1 Listas por tipo<a class="headerlink" href="#listas-por-tipo" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-station-lists"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-station-lists"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Listas de estações</span><a class="headerlink" href="#id3" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">reftek_stations</span><span class="o">=(</span>PRB1<span class="w"> </span>BC9<span class="w"> </span>BC4<span class="w"> </span>BCM2<span class="w"> </span>SP7<span class="w"> </span>IT1<span class="o">)</span>
<span class="nb">declare</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">raspberry_stations</span><span class="o">=(</span>MC9<span class="w"> </span>IT9<span class="o">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reftek_stations</span></code>: estações processadas pelo fluxo RT130.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raspberry_stations</span></code>: estações processadas pelo fluxo Raspberry Shake.</p></li>
</ul>
<p>Essas listas alimentam a detecção de <code class="docutils literal notranslate"><span class="pre">station_type</span></code>.</p>
</section>
<section id="das-codes">
<span id="sync-das-codes"></span><h3>2.2 <code class="docutils literal notranslate"><span class="pre">das_codes</span></code><a class="headerlink" href="#das-codes" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-das-codes"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-das-codes"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Mapa de DAS codes</span><a class="headerlink" href="#id4" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">das_codes</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span>BCM2<span class="o">]=</span>AD19
<span class="w">    </span><span class="o">[</span>PRB1<span class="o">]=</span><span class="s2">&quot;AD20&quot;</span><span class="w">   </span><span class="c1"># suporte a múltiplos códigos: basta separar por espaço (ex: &quot;AD20 9789&quot;)</span>
<span class="w">    </span><span class="o">[</span>BC9<span class="o">]=</span><span class="m">9690</span>
<span class="w">    </span><span class="o">[</span>SP7<span class="o">]=</span>9FD3
<span class="w">    </span><span class="o">[</span>IT1<span class="o">]=</span>B438
<span class="w">    </span><span class="o">[</span>BC4<span class="o">]=</span><span class="m">9775</span>
<span class="w">    </span><span class="o">[</span>MC9<span class="o">]=</span>REDD8
<span class="w">    </span><span class="o">[</span>IT9<span class="o">]=</span>REDD8
</pre></div>
</div>
</div>
<p>Mapeia <code class="docutils literal notranslate"><span class="pre">ESTACAO</span> <span class="pre">→</span> <span class="pre">DAS_CODE</span></code> (ou serial/código de origem).</p>
<ul class="simple">
<li><p>Suporta <strong>múltiplos códigos</strong> em uma mesma estação (valor contendo espaço), por exemplo: <code class="docutils literal notranslate"><span class="pre">&quot;AD20</span> <span class="pre">9789&quot;</span></code>.</p></li>
<li><p>Esse suporte é consumido por:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">build_code_pattern</span></code> (regex <code class="docutils literal notranslate"><span class="pre">A|B|C</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">split_das_codes</span></code> (array de códigos)</p></li>
</ul>
</li>
</ul>
</section>
<section id="projects-project-map">
<span id="sync-projects"></span><h3>2.3 <code class="docutils literal notranslate"><span class="pre">projects</span></code> + <code class="docutils literal notranslate"><span class="pre">project_map</span></code><a class="headerlink" href="#projects-project-map" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-projects"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-projects"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Lista de projetos</span><a class="headerlink" href="#id5" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">projects</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span><span class="m">1</span><span class="o">]=</span><span class="s2">&quot;BAESA ENERCAN|BC4&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">2</span><span class="o">]=</span><span class="s2">&quot;BAESA ENERCAN|BC9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">3</span><span class="o">]=</span><span class="s2">&quot;PARAIBUNA|PRB1&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">4</span><span class="o">]=</span><span class="s2">&quot;ITA|IT9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">5</span><span class="o">]=</span><span class="s2">&quot;ITA|IT1&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">6</span><span class="o">]=</span><span class="s2">&quot;MACHADINHO|BCM2&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">7</span><span class="o">]=</span><span class="s2">&quot;MACHADINHO|MC9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">8</span><span class="o">]=</span><span class="s2">&quot;SALTO PILAO|SP7&quot;</span>
</pre></div>
</div>
</div>
<p id="sync-project-map">[<a class="reference internal" href="api/sync.html#api-sync-project-map"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-project-map"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Mapa de projetos</span><a class="headerlink" href="#id6" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">project_map</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span><span class="s2">&quot;BAESA ENERCAN&quot;</span><span class="o">]=</span>BC
<span class="w">    </span><span class="o">[</span>PARAIBUNA<span class="o">]=</span>BL
<span class="w">    </span><span class="o">[</span>ITA<span class="o">]=</span>IT
<span class="w">    </span><span class="o">[</span>MACHADINHO<span class="o">]=</span>MC
<span class="w">    </span><span class="o">[</span>SALTO<span class="w"> </span>PILAO<span class="o">]=</span>SP
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">projects</span></code>: menu de escolha <strong>Projeto|Estação</strong>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project_map</span></code>: Projeto → código de rede SDS (<code class="docutils literal notranslate"><span class="pre">BC</span></code>, <code class="docutils literal notranslate"><span class="pre">BL</span></code>, <code class="docutils literal notranslate"><span class="pre">IT</span></code>, <code class="docutils literal notranslate"><span class="pre">MC</span></code>, <code class="docutils literal notranslate"><span class="pre">SP</span></code>).</p></li>
</ul>
<p>No fluxo, o <code class="docutils literal notranslate"><span class="pre">project_code</span></code> sempre vem de <code class="docutils literal notranslate"><span class="pre">project_map[PROJETO_ESCOLHIDO]</span></code>.</p>
</section>
<section id="futura-expansao">
<h3>2.4 Futura expansão<a class="headerlink" href="#futura-expansao" title="Link permanente para este cabeçalho">#</a></h3>
<p>O inventário estático pode ser expandido com novas estações e projetos utilizando PARFILE</p>
</section>
</section>
<hr class="docutils" />
<section id="variaveis-globais-para-compatibilidade-com-set-u">
<h2>3) Variáveis globais (para compatibilidade com <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-u</span></code>)<a class="headerlink" href="#variaveis-globais-para-compatibilidade-com-set-u" title="Link permanente para este cabeçalho">#</a></h2>
<section id="globais-inicializadas-com-string-vazia">
<span id="sync-globals"></span><h3>3.1 Globais inicializadas com string vazia<a class="headerlink" href="#globais-inicializadas-com-string-vazia" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-globals"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-globals"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Globais inicializadas</span><a class="headerlink" href="#id7" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PROJETO_ESCOLHIDO</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ESTACAO_ESCOLHIDA</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="c1"># IMPORTANTE: manter sempre definido (mesmo que vazio) para não quebrar com set -u</span>
<span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<p>O script define antecipadamente (vazio) variáveis que serão preenchidas no <code class="docutils literal notranslate"><span class="pre">main</span></code>:</p>
<ul class="simple">
<li><p>Identidade / contexto:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">PROJETO_ESCOLHIDO</span></code>, <code class="docutils literal notranslate"><span class="pre">ESTACAO_ESCOLHIDA</span></code>, <code class="docutils literal notranslate"><span class="pre">ANO_FORCADO</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project_code</span></code>, <code class="docutils literal notranslate"><span class="pre">das_code</span></code>, <code class="docutils literal notranslate"><span class="pre">origin_dir</span></code>, <code class="docutils literal notranslate"><span class="pre">station_type</span></code></p></li>
</ul>
</li>
<li><p>Seleção do pacote:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip</span></code>, <code class="docutils literal notranslate"><span class="pre">closest_zip_orig</span></code>, <code class="docutils literal notranslate"><span class="pre">closest_date</span></code>, <code class="docutils literal notranslate"><span class="pre">last_date</span></code></p></li>
</ul>
</li>
<li><p>Estado SDS:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span></code>, <code class="docutils literal notranslate"><span class="pre">ano_sinc</span></code></p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">code_pattern</span></code></strong>: inicializado como <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> para não quebrar <code class="docutils literal notranslate"><span class="pre">-u</span></code>.</p></li>
</ul>
<p><strong>Invariante importante do fluxo:</strong> antes de procurar datas REFTEK em arquivos compactados, <code class="docutils literal notranslate"><span class="pre">code_pattern</span></code> precisa estar <strong>não vazio</strong>, pois vira a lista de DAS codes aceitos (formato <code class="docutils literal notranslate"><span class="pre">A|B|C</span></code>).</p>
</section>
</section>
<hr class="docutils" />
<section id="suporte-a-multiplos-das-code">
<h2>4) Suporte a múltiplos DAS_CODE<a class="headerlink" href="#suporte-a-multiplos-das-code" title="Link permanente para este cabeçalho">#</a></h2>
<section id="build-code-pattern">
<span id="sync-build-code-pattern"></span><h3>4.1 <code class="docutils literal notranslate"><span class="pre">build_code_pattern()</span></code><a class="headerlink" href="#build-code-pattern" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-build-code-pattern"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-build-code-pattern"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">build_code_pattern</span><a class="headerlink" href="#id8" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_code_pattern<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span>codes
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>codes<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dc</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">pat</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">pat</span><span class="o">+=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pat</span><span class="p">:+|</span><span class="si">}</span><span class="nv">$c</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;%s&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$pat</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Transforma uma string com possíveis múltiplos códigos (separados por espaço) em uma alternativa regex com <code class="docutils literal notranslate"><span class="pre">|</span></code>.</p>
<ul class="simple">
<li><p>Entrada: <code class="docutils literal notranslate"><span class="pre">&quot;AD20</span> <span class="pre">9789&quot;</span></code></p></li>
<li><p>Saída: <code class="docutils literal notranslate"><span class="pre">&quot;AD20|9789&quot;</span></code></p></li>
</ul>
<p>Esse padrão é usado pela extração de datas REFTEK em qualquer profundidade (função <code class="docutils literal notranslate"><span class="pre">extract_reftek_dates_any_depth</span></code>).</p>
</section>
<section id="split-das-codes">
<span id="sync-split-das-codes"></span><h3>4.2 <code class="docutils literal notranslate"><span class="pre">split_das_codes()</span></code><a class="headerlink" href="#split-das-codes" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-split-das-codes"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-split-das-codes"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">split_das_codes</span><a class="headerlink" href="#id9" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>split_das_codes<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>_CODES_SPLIT<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dc</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Gera o array global <code class="docutils literal notranslate"><span class="pre">_CODES_SPLIT</span></code> com os DAS codes individuais.</p>
<p>É usado principalmente dentro do <code class="docutils literal notranslate"><span class="pre">processar_reftek</span></code> para montar buscas com <code class="docutils literal notranslate"><span class="pre">find</span></code>.</p>
</section>
</section>
<hr class="docutils" />
<section id="funcoes-utilitarias-gerais">
<h2>5) Funções utilitárias gerais<a class="headerlink" href="#funcoes-utilitarias-gerais" title="Link permanente para este cabeçalho">#</a></h2>
<section id="log-debug">
<span id="sync-log-debug"></span><h3>5.1 <code class="docutils literal notranslate"><span class="pre">log_debug()</span></code><a class="headerlink" href="#log-debug" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-log-debug"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-log-debug"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">log_debug</span><a class="headerlink" href="#id10" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>log_debug<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VERBOSE</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[DEBUG] </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
</pre></div>
</div>
</div>
<p>Imprime mensagens de debug quando <code class="docutils literal notranslate"><span class="pre">VERBOSE=1</span></code> (definido no main).</p>
</section>
<section id="dia-juliano">
<span id="sync-dia-juliano"></span><h3>5.2 <code class="docutils literal notranslate"><span class="pre">dia_juliano()</span></code><a class="headerlink" href="#dia-juliano" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-dia-juliano"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-dia-juliano"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">dia_juliano</span><a class="headerlink" href="#id11" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>dia_juliano<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>+%j<span class="p">;</span><span class="w"> </span><span class="o">}</span>
</pre></div>
</div>
</div>
<p>Converte data gregoriana para dia juliano via <code class="docutils literal notranslate"><span class="pre">date</span> <span class="pre">-d</span> <span class="pre">...</span> <span class="pre">+%j</span></code>.</p>
<p><strong>Observação:</strong> no script atual, ela está definida mas não é chamada em nenhum ponto.</p>
</section>
<section id="is-station-in-list">
<span id="sync-is-station-in-list"></span><h3>5.3 <code class="docutils literal notranslate"><span class="pre">is_station_in_list()</span></code><a class="headerlink" href="#is-station-in-list" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-is-station-in-list"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-is-station-in-list"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">is_station_in_list</span><a class="headerlink" href="#id12" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>is_station_in_list<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">station</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>e
<span class="w">    </span><span class="k">for</span><span class="w"> </span>e<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Checa pertencimento de uma estação em uma lista (retorno 0/1).</p>
<p>É usada para classificar <code class="docutils literal notranslate"><span class="pre">station_type</span></code>.</p>
</section>
</section>
<hr class="docutils" />
<section id="selecao-projeto-estacao-modo-interativo">
<h2>6) Seleção Projeto/Estação (modo interativo)<a class="headerlink" href="#selecao-projeto-estacao-modo-interativo" title="Link permanente para este cabeçalho">#</a></h2>
<section id="seleciona-projeto-estacao">
<span id="sync-seleciona-projeto"></span><h3>6.1 <code class="docutils literal notranslate"><span class="pre">seleciona_projeto_estacao()</span></code><a class="headerlink" href="#seleciona-projeto-estacao" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-seleciona-projeto"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-seleciona-projeto"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">seleciona_projeto_estacao</span><a class="headerlink" href="#id13" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>seleciona_projeto_estacao<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Selecione o Projeto e Estação:&quot;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>key<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!projects[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>p<span class="w"> </span>e<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;   %2s) Projeto: %-15s | Estação: %-4s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">read</span><span class="w"> </span>-rp<span class="w"> </span><span class="s1">$&#39;\nDigite o número correspondente: &#39;</span><span class="w"> </span>escolha
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$escolha</span><span class="p">]</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Seleção inválida. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>PROJETO_ESCOLHIDO<span class="w"> </span>ESTACAO_ESCOLHIDA<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$escolha</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_map</span><span class="p">[</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_codes</span><span class="p">[</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># &gt;&gt;&gt; FIX CRÍTICO: code_pattern sempre definido aqui</span>
<span class="w">    </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">reftek_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;reftek&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Reftek.&quot;</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raspberry_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;raspberry&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Raspberry Shake.&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Estação &#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não reconhecida. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Fluxo:</p>
<ol class="arabic simple">
<li><p>Imprime menu enumerando <code class="docutils literal notranslate"><span class="pre">projects</span></code>.</p></li>
<li><p>Lê a opção do usuário.</p></li>
<li><p>Deriva e define:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PROJETO_ESCOLHIDO</span></code>, <code class="docutils literal notranslate"><span class="pre">ESTACAO_ESCOLHIDA</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">project_code</span></code> via <code class="docutils literal notranslate"><span class="pre">project_map</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">das_code</span></code> via <code class="docutils literal notranslate"><span class="pre">das_codes</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">origin_dir</span> <span class="pre">=</span> <span class="pre">$base_dir/ZIP/$ESTACAO_ESCOLHIDA</span></code></p></li>
</ul>
</li>
<li><p><strong>Define <code class="docutils literal notranslate"><span class="pre">code_pattern</span></code> obrigatoriamente</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">code_pattern=&quot;$(build_code_pattern</span> <span class="pre">&quot;$das_code&quot;)&quot;</span></code></p></li>
<li><p>aborta se ficar vazio</p></li>
</ul>
</li>
<li><p>Classifica <code class="docutils literal notranslate"><span class="pre">station_type</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reftek</span></code> se estação está em <code class="docutils literal notranslate"><span class="pre">reftek_stations</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raspberry</span></code> se está em <code class="docutils literal notranslate"><span class="pre">raspberry_stations</span></code></p></li>
<li><p>aborta se não reconhecida</p></li>
</ul>
</li>
</ol>
<p><strong>Efeito no resto do script:</strong> após esta função, o contexto mínimo do processamento está fechado: rede SDS (<code class="docutils literal notranslate"><span class="pre">project_code</span></code>), estação, DAS code(s), tipo.</p>
</section>
</section>
<hr class="docutils" />
<section id="determinar-o-ultimo-sincronizado-na-sds">
<h2>7) Determinar o último sincronizado na SDS<a class="headerlink" href="#determinar-o-ultimo-sincronizado-na-sds" title="Link permanente para este cabeçalho">#</a></h2>
<section id="obter-ultimo-sinc">
<span id="sync-obter-ultimo-sinc"></span><h3>7.1 <code class="docutils literal notranslate"><span class="pre">obter_ultimo_sinc()</span></code><a class="headerlink" href="#obter-ultimo-sinc" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-obter-ultimo-sinc"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-obter-ultimo-sinc"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">obter_ultimo_sinc</span><a class="headerlink" href="#id14" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>obter_ultimo_sinc<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FORCE_SYNC</span><span class="s2">&quot;</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] [FORCE] Sincronização forçada: ignorando último dia na SDS.&quot;</span>
<span class="w">        </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="m">0</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização forçada ativa: definido ultimo_sinc=0&quot;</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>ano_atual
<span class="w">    </span><span class="nv">ano_atual</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">tentativas</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ano_atual</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$((</span><span class="nv">ano_atual</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">encontrado</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>ano
<span class="w">    </span><span class="k">for</span><span class="w"> </span>ano<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tentativas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">sds_dir</span><span class="o">=</span><span class="s2">&quot;/SDS/</span><span class="nv">$ano</span><span class="s2">/</span><span class="nv">$project_code</span><span class="s2">/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">/HHZ.D&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>last_file
<span class="w">            </span><span class="nv">last_file</span><span class="o">=</span><span class="k">$(</span>
<span class="w">                </span>ls<span class="w"> </span>-1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1
<span class="w">            </span><span class="k">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nv">encontrado</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ano</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$encontrado</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Não foi possível obter o último dia sincronizado na SDS. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$encontrado</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Último dia sincronizado na SDS (ano </span><span class="nv">$ano_sinc</span><span class="s2">): </span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Esta função define o ponto de partida “a partir de onde procurar dados novos”.</p>
<section id="caso-a-sincronizacao-forcada-com-opcao-f-force-sync-1">
<h4>Caso A — sincronização forçada com opção -f (<code class="docutils literal notranslate"><span class="pre">FORCE_SYNC=1</span></code>)<a class="headerlink" href="#caso-a-sincronizacao-forcada-com-opcao-f-force-sync-1" title="Link permanente para este cabeçalho">#</a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ano_sinc</span> <span class="pre">=</span> <span class="pre">ano</span> <span class="pre">atual</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span> <span class="pre">=</span> <span class="pre">0</span></code></p></li>
</ul>
<p>Isso faz com que qualquer pacote com datas internas seja considerado “novo”.</p>
</section>
<section id="caso-b-regra-padrao">
<h4>Caso B — regra padrão<a class="headerlink" href="#caso-b-regra-padrao" title="Link permanente para este cabeçalho">#</a></h4>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ano_atual</span> <span class="pre">=</span> <span class="pre">date</span> <span class="pre">+%Y</span></code></p></li>
<li><p>tenta:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ano_atual</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ano_atual</span> <span class="pre">-</span> <span class="pre">1</span></code></p></li>
</ul>
</li>
<li><p>Para cada ano, checa o diretório:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/SDS/&lt;ANO&gt;/&lt;project_code&gt;/&lt;ESTACAO_ESCOLHIDA&gt;/HHZ.D</span></code></p></li>
</ul>
</li>
<li><p>Se existir, obtém o último <code class="docutils literal notranslate"><span class="pre">JJJ</span></code> presente:</p>
<ul class="simple">
<li><p>lista arquivos</p></li>
<li><p>extrai último campo após <code class="docutils literal notranslate"><span class="pre">.</span></code> (<code class="docutils literal notranslate"><span class="pre">awk</span> <span class="pre">-F'.'</span> <span class="pre">'{print</span> <span class="pre">$NF}'</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sort</span> <span class="pre">-u</span> <span class="pre">|</span> <span class="pre">tail</span> <span class="pre">-n1</span></code></p></li>
</ul>
</li>
</ol>
<p>Resultado:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ano_sinc</span> <span class="pre">=</span> <span class="pre">ano</span> <span class="pre">encontrado</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span> <span class="pre">=</span> <span class="pre">último</span> <span class="pre">JJJ</span> <span class="pre">encontrado</span></code></p></li>
</ul>
<p><strong>Ponto operacional:</strong> esse <code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span></code> é comparado com as datas internas dos pacotes para decidir o que é “novo”.</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="suporte-a-arquivos-compactados-e-listagem-de-paths-internos">
<h2>8) Suporte a arquivos compactados e listagem de paths internos<a class="headerlink" href="#suporte-a-arquivos-compactados-e-listagem-de-paths-internos" title="Link permanente para este cabeçalho">#</a></h2>
<p>Esses blocos são usados pela seleção automática do pacote “closest”.</p>
<section id="prepare-archive">
<span id="sync-prepare-archive"></span><h3>8.1 <code class="docutils literal notranslate"><span class="pre">prepare_archive()</span></code><a class="headerlink" href="#prepare-archive" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-prepare-archive"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-prepare-archive"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">prepare_archive</span><a class="headerlink" href="#id15" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>prepare_archive<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="k">in</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_ORIG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>*.zip.bz2<span class="o">)</span>
<span class="w">            </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">cache_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/_ARCHIVE_CACHE&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cache_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">ARCH_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$cache_dir</span><span class="s2">/</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">in</span><span class="p">%.bz2</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>-nt<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Detectado .zip.bz2: descompactando para cache → </span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>bzip2<span class="w"> </span>-dc<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span>rm<span class="w"> </span>-f<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - [ERRO] Falha ao descompactar </span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>unzip<span class="w"> </span>-tqq<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span>rm<span class="w"> </span>-f<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - [ERRO] Cache gerado não é um ZIP válido: </span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="p">;;</span>
<span class="w">        </span>*.zip<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*.rar<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;rar&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*.tar<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;tar&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Normaliza a entrada e define 3 globais:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ARCH_ORIG</span></code>: caminho original do arquivo</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ARCH_FILE</span></code>: arquivo que será efetivamente inspecionado</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ARCH_KIND</span></code>: <code class="docutils literal notranslate"><span class="pre">zip|rar|tar</span></code></p></li>
</ul>
<p>Casos:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*.zip.bz2</span></code>:</p>
<ul>
<li><p>descompacta para cache em <code class="docutils literal notranslate"><span class="pre">$base_dir/_ARCHIVE_CACHE/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ARCH_FILE</span></code> vira o <code class="docutils literal notranslate"><span class="pre">.zip</span></code> descompactado</p></li>
<li><p>valida integridade via <code class="docutils literal notranslate"><span class="pre">unzip</span> <span class="pre">-tqq</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">*.zip</span></code>, <code class="docutils literal notranslate"><span class="pre">*.rar</span></code>, <code class="docutils literal notranslate"><span class="pre">*.tar</span></code>: define <code class="docutils literal notranslate"><span class="pre">ARCH_KIND</span></code> e usa o próprio arquivo</p></li>
<li><p>outros: retorna <code class="docutils literal notranslate"><span class="pre">2</span></code> (extensão não suportada)</p></li>
</ul>
</section>
<section id="list-archive-paths">
<span id="sync-list-archive-paths"></span><h3>8.2 <code class="docutils literal notranslate"><span class="pre">list_archive_paths()</span></code><a class="headerlink" href="#list-archive-paths" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-list-archive-paths"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-list-archive-paths"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">list_archive_paths</span><a class="headerlink" href="#id16" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>list_archive_paths<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>zip<span class="o">)</span><span class="w"> </span>unzip<span class="w"> </span>-Z1<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>rar<span class="o">)</span><span class="w"> </span>unrar<span class="w"> </span>lb<span class="w"> </span>-p-<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>tar<span class="o">)</span><span class="w"> </span>tar<span class="w"> </span>-tf<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Lista caminhos internos sem extrair:</p>
<ul class="simple">
<li><p>zip: <code class="docutils literal notranslate"><span class="pre">unzip</span> <span class="pre">-Z1</span></code></p></li>
<li><p>rar: <code class="docutils literal notranslate"><span class="pre">unrar</span> <span class="pre">lb</span> <span class="pre">-p-</span></code></p></li>
<li><p>tar: <code class="docutils literal notranslate"><span class="pre">tar</span> <span class="pre">-tf</span></code></p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="extracao-de-datas-internas-do-pacote">
<h2>9) Extração de “datas internas” do pacote<a class="headerlink" href="#extracao-de-datas-internas-do-pacote" title="Link permanente para este cabeçalho">#</a></h2>
<p>A seleção do pacote depende de conseguir extrair <strong>quais dias (YYYYJJJ)</strong> existem dentro do arquivo.</p>
<section id="raspberry-extract-dates-from-rasp">
<span id="sync-extract-dates-rasp"></span><h3>9.1 Raspberry: <code class="docutils literal notranslate"><span class="pre">extract_dates_from_rasp()</span></code><a class="headerlink" href="#raspberry-extract-dates-from-rasp" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-extract-dates-rasp"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-extract-dates-rasp"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">extract_dates_from_rasp</span><a class="headerlink" href="#id17" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>extract_dates_from_rasp<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">zip_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="w">    </span>unzip<span class="w"> </span>-Z1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;/data/archive/[0-9]{4}/AM/</span><span class="si">${</span><span class="nv">das_code</span><span class="si">}</span><span class="s2">/EH[ZEN]\.D/&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">        year = $(NF-1)</span>
<span class="s1">        jul  = $NF</span>
<span class="s1">        if (year ~ /^[0-9]{4}$/ &amp;&amp; jul ~ /^[0-9]{3}$/) print year jul</span>
<span class="s1">    }&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Procura entradas no padrão:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/data/archive/&lt;YYYY&gt;/AM/&lt;das_code&gt;/EH[ZEN].D/</span></code></p></li>
</ul>
<p>Extrai <code class="docutils literal notranslate"><span class="pre">YYYY</span></code> e <code class="docutils literal notranslate"><span class="pre">JJJ</span></code> do final do path (parte <code class="docutils literal notranslate"><span class="pre">...&lt;YYYY&gt;.&lt;JJJ&gt;</span></code>), retornando <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> ordenado e único.</p>
</section>
<section id="reftek-qualquer-profundidade-extract-reftek-dates-any-depth">
<span id="sync-extract-reftek-dates"></span><h3>9.2 REFTEK (qualquer profundidade): <code class="docutils literal notranslate"><span class="pre">extract_reftek_dates_any_depth()</span></code><a class="headerlink" href="#reftek-qualquer-profundidade-extract-reftek-dates-any-depth" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-extract-reftek-dates"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-extract-reftek-dates"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">extract_reftek_dates_any_depth</span><a class="headerlink" href="#id18" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>extract_reftek_dates_any_depth<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">codes_pat</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span><span class="w">   </span><span class="c1"># ex: &quot;9690|AD20&quot;</span>

<span class="w">    </span>list_archive_paths<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">codes</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$codes_pat</span><span class="s2">&quot;</span><span class="w"> </span>-F<span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">        BEGIN {</span>
<span class="s1">            n = split(codes, C, &quot;|&quot;)</span>
<span class="s1">        }</span>
<span class="s1">        function iscode(x){</span>
<span class="s1">            for(i=1;i&lt;=n;i++) if(x==C[i]) return 1</span>
<span class="s1">            return 0</span>
<span class="s1">        }</span>
<span class="s1">        function isdate(x){</span>
<span class="s1">            return (x ~ /^[0-9]{7}([_-].+)?$/)</span>
<span class="s1">        }</span>
<span class="s1">        {</span>
<span class="s1">            if ($1 == &quot;.&quot;) { for (k=1;k&lt;NF;k++) $k=$(k+1); NF=NF-1 }</span>

<span class="s1">            for(i=1; i&lt;=NF-2; i++){</span>
<span class="s1">                if (isdate($i) &amp;&amp; iscode($(i+1)) &amp;&amp; ( $(i+2)==&quot;0&quot; || $(i+2)==&quot;1&quot; )) {</span>
<span class="s1">                    print $i</span>
<span class="s1">                    break</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Objetivo: encontrar diretórios que indiquem a presença de dados no padrão REFTEK:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">YYYYJJJ/&lt;DAS&gt;/0</span></code> e <code class="docutils literal notranslate"><span class="pre">YYYYJJJ/&lt;DAS&gt;/1</span></code></p></li>
</ul>
<p>Características:</p>
<ul class="simple">
<li><p>não assume profundidade fixa (funciona se o pacote tiver prefixos extras)</p></li>
<li><p>trata paths com <code class="docutils literal notranslate"><span class="pre">./</span></code> no início</p></li>
<li><p>aceita múltiplos DAS via <code class="docutils literal notranslate"><span class="pre">codes_pat</span></code> (<code class="docutils literal notranslate"><span class="pre">A|B|C</span></code>) (PARB ocorreu de mudar o DAS_CODE, por isto foi necessário criar uma função que aceite uma lista de DAS codes)</p></li>
<li><p>aceita <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> com sufixo (<code class="docutils literal notranslate"><span class="pre">YYYYJJJ_...</span></code>), mas reduz para os 7 dígitos depois</p></li>
</ul>
<p>Saída: lista de “datas brutas” (o token do <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> possivelmente com sufixo), depois o chamador normaliza para <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> puro.</p>
</section>
</section>
<hr class="docutils" />
<section id="selecao-automatica-do-pacote-closest">
<h2>10) Seleção automática do pacote “closest”<a class="headerlink" href="#selecao-automatica-do-pacote-closest" title="Link permanente para este cabeçalho">#</a></h2>
<section id="encontrar-closest-zip">
<span id="sync-encontrar-closest-zip"></span><h3>10.1 <code class="docutils literal notranslate"><span class="pre">encontrar_closest_zip()</span></code><a class="headerlink" href="#encontrar-closest-zip" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-encontrar-closest-zip"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-encontrar-closest-zip"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">encontrar_closest_zip</span><a class="headerlink" href="#id19" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>encontrar_closest_zip<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">best_diff</span><span class="o">=</span><span class="m">999</span>

<span class="w">    </span><span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_code</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] das_code vazio&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">code_pattern</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">code_pattern</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>arquivo
<span class="w">    </span><span class="k">for</span><span class="w"> </span>arquivo<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$origin_dir</span><span class="s2">&quot;</span>/*<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$arquivo</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>

<span class="w">        </span><span class="nb">echo</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Analisando arquivo: </span><span class="nv">$arquivo</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>prepare_archive<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$arquivo</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extensão não suportada (ou falha ao preparar archive). Pulando.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_KIND</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">work_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">raw_datas</span><span class="o">=()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;raspberry&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>mapfile<span class="w"> </span>-t<span class="w"> </span>raw_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>extract_dates_from_rasp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>mapfile<span class="w"> </span>-t<span class="w"> </span>raw_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">                </span>extract_reftek_dates_any_depth<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="o">)</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">raw_datas</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Pastas internas encontradas (bruto):&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_datas</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Sem pastas internas (YYYYJJJ/DAS/[01]) em </span><span class="nv">$arquivo</span><span class="s2">.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">todas_datas</span><span class="o">=()</span>
<span class="w">        </span>mapfile<span class="w"> </span>-t<span class="w"> </span>todas_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">            </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_datas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/^([0-9]{7}).*$/\1/&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="w">        </span><span class="o">)</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Datas internas puras:&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">todas_datas</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">valid_new_dates</span><span class="o">=()</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>dia
<span class="w">        </span><span class="k">for</span><span class="w"> </span>dia<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">todas_datas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian</span><span class="o">=</span><span class="si">${</span><span class="nv">dia</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span>
<span class="w">            </span><span class="o">((</span><span class="w"> </span><span class="m">10</span><span class="c1">#$julian &gt;= 10#$ultimo_sinc )) &amp;&amp; valid_new_dates+=(&quot;$dia&quot;)</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">valid_new_dates</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Nenhuma data ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2"> neste arquivo.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">first_new</span><span class="o">=</span><span class="si">${</span><span class="nv">valid_new_dates</span><span class="p">[0]</span><span class="si">}</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">last_new</span><span class="o">=</span><span class="si">${</span><span class="nv">valid_new_dates</span><span class="p">[-1]</span><span class="si">}</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">diff</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="m">10#</span><span class="si">${</span><span class="nv">first_new</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">10#</span><span class="nv">$ultimo_sinc</span><span class="w"> </span><span class="k">))</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Primeiro dia novo ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2">: </span><span class="nv">$first_new</span><span class="s2"> (diff=</span><span class="nv">$diff</span><span class="s2">)&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>diff<span class="w"> </span>&lt;<span class="w"> </span>best_diff<span class="w"> </span><span class="o">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">           </span><span class="o">((</span><span class="w"> </span><span class="nv">diff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>best_diff<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="m">10</span><span class="c1">#${last_new:4:3} &gt; 10#${last_date:4:3} )); then</span>
<span class="w">            </span><span class="nv">best_diff</span><span class="o">=</span><span class="nv">$diff</span>
<span class="w">            </span><span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_ORIG</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$first_new</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_new</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo adequado encontrado (.zip, .rar ou .tar). Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>closest_gregorian
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>last_gregorian
<span class="w">    </span><span class="nv">closest_gregorian</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y-%m-%d<span class="k">)</span>
<span class="w">    </span><span class="nv">last_gregorian</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y-%m-%d<span class="k">)</span>

<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;###############################################&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ ARQUIVO ESCOLHIDO PARA SINCRONIZAÇÃO:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Arquivo:      </span><span class="nv">$closest_zip</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Primeiro dia: </span><span class="nv">$closest_date</span><span class="s2"> - </span><span class="nv">$closest_gregorian</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Último dia:   </span><span class="nv">$last_date</span><span class="s2"> - </span><span class="nv">$last_gregorian</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;###############################################&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Percorre todos os arquivos em <code class="docutils literal notranslate"><span class="pre">ZIP/&lt;ESTACAO&gt;/</span></code> e escolhe o melhor candidato com base no último sincronizado.</p>
<section id="inicializacao">
<h4>10.1.1 Inicialização<a class="headerlink" href="#inicializacao" title="Link permanente para este cabeçalho">#</a></h4>
<ul class="simple">
<li><p>define <code class="docutils literal notranslate"><span class="pre">best_diff=999</span></code></p></li>
<li><p>zera variáveis globais de seleção</p></li>
<li><p>garante <code class="docutils literal notranslate"><span class="pre">das_code</span></code> e <code class="docutils literal notranslate"><span class="pre">code_pattern</span></code> não vazios</p></li>
<li><p>ativa <code class="docutils literal notranslate"><span class="pre">nullglob</span></code> para o loop não iterar literal <code class="docutils literal notranslate"><span class="pre">*</span></code> se diretório vazio</p></li>
</ul>
</section>
<section id="loop-por-arquivo">
<h4>10.1.2 Loop por arquivo<a class="headerlink" href="#loop-por-arquivo" title="Link permanente para este cabeçalho">#</a></h4>
<p>Para cada <code class="docutils literal notranslate"><span class="pre">arquivo</span></code>:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">prepare_archive</span> <span class="pre">arquivo</span></code></p>
<ul class="simple">
<li><p>se extensão não suportada: pula</p></li>
</ul>
</li>
<li><p>extrai datas internas conforme <code class="docutils literal notranslate"><span class="pre">station_type</span></code>:</p>
<ul class="simple">
<li><p>Raspberry: <code class="docutils literal notranslate"><span class="pre">extract_dates_from_rasp</span></code></p></li>
<li><p>Reftek: <code class="docutils literal notranslate"><span class="pre">extract_reftek_dates_any_depth</span></code></p></li>
</ul>
</li>
<li><p>normaliza para <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> puro (remove sufixos) e ordena</p></li>
<li><p>filtra datas “novas”:</p>
<ul class="simple">
<li><p>mantém <code class="docutils literal notranslate"><span class="pre">dia</span></code> com <code class="docutils literal notranslate"><span class="pre">JJJ</span> <span class="pre">&gt;=</span> <span class="pre">ultimo_sinc</span></code></p></li>
<li><p>usa <code class="docutils literal notranslate"><span class="pre">10#</span></code> para evitar interpretação octal (ex.: <code class="docutils literal notranslate"><span class="pre">008</span></code>)</p></li>
</ul>
</li>
<li><p>define:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">first_new</span></code> = primeiro dia novo</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">last_new</span></code> = último dia novo</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">diff</span> <span class="pre">=</span> <span class="pre">first_new.JJJ</span> <span class="pre">-</span> <span class="pre">ultimo_sinc</span></code></p></li>
</ul>
</li>
<li><p>atualiza o “melhor” candidato:</p>
<ul class="simple">
<li><p>menor <code class="docutils literal notranslate"><span class="pre">diff</span></code> vence</p></li>
<li><p>empate em <code class="docutils literal notranslate"><span class="pre">diff</span></code>: maior <code class="docutils literal notranslate"><span class="pre">last_new</span></code> vence</p></li>
</ul>
</li>
</ol>
</section>
<section id="resultado-consolidado">
<h4>10.1.3 Resultado consolidado<a class="headerlink" href="#resultado-consolidado" title="Link permanente para este cabeçalho">#</a></h4>
<p>Após o loop, define:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip</span></code> (arquivo efetivo, já “normalizado” pelo cache se <code class="docutils literal notranslate"><span class="pre">.zip.bz2</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip_orig</span></code> (arquivo original)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_date</span></code> (primeiro dia “novo” no arquivo)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">last_date</span></code> (último dia disponível no arquivo)</p></li>
</ul>
<p>E imprime também as datas gregorianas derivadas de <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code>.</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="validacao-e-tolerancias-do-parfile-bloco-transversal-do-reftek">
<h2>11) Validação e tolerâncias do <code class="docutils literal notranslate"><span class="pre">parfile</span></code> (bloco transversal do REFTEK)<a class="headerlink" href="#validacao-e-tolerancias-do-parfile-bloco-transversal-do-reftek" title="Link permanente para este cabeçalho">#</a></h2>
<p>Estas funções não fazem a seleção do pacote; elas entram no <strong>fluxo REFTEK</strong> após o modo exploratório do <code class="docutils literal notranslate"><span class="pre">rt2ms</span></code>.</p>
<section id="comparar-parfiles-com-tolerancia">
<span id="sync-comparar-parfiles"></span><h3>11.1 <code class="docutils literal notranslate"><span class="pre">comparar_parfiles_com_tolerancia()</span></code><a class="headerlink" href="#comparar-parfiles-com-tolerancia" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-comparar-parfiles"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-comparar-parfiles"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">comparar_parfiles_com_tolerancia</span><a class="headerlink" href="#id20" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>comparar_parfiles_com_tolerancia<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">par_template</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">par_expl</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="w">    </span>awk<span class="w"> </span>-F<span class="s1">&#39;;&#39;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">      function trim(s){ gsub(/^[ \t]+|[ \t]+$/, &quot;&quot;, s); return s }</span>

<span class="s1">      NR==FNR {</span>
<span class="s1">          if (FNR == 1) { header_expl = $0; next }</span>
<span class="s1">          for (i=1;i&lt;=NF;i++) $i = trim($i)</span>
<span class="s1">          key = $1 &quot;|&quot; $2 &quot;|&quot; $3</span>
<span class="s1">          a_net[key]   = $4</span>
<span class="s1">          a_sta[key]   = $5</span>
<span class="s1">          a_loc[key]   = $6</span>
<span class="s1">          a_chan[key]  = $7</span>
<span class="s1">          a_sr[key]    = $8</span>
<span class="s1">          a_gain[key]  = $9</span>
<span class="s1">          a_itime[key] = $10</span>
<span class="s1">          has_expl[key]= 1</span>
<span class="s1">          next</span>
<span class="s1">      }</span>

<span class="s1">      FNR == 1 {</span>
<span class="s1">          header_tmpl = $0</span>
<span class="s1">          if (header_tmpl != header_expl) {</span>
<span class="s1">              printf(&quot;[ERRO] Cabeçalho do parfile exploratório difere do template.\n&quot;) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              printf(&quot;       template:     %s\n&quot;, header_tmpl)  &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              printf(&quot;       exploratório: %s\n&quot;, header_expl)  &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>
<span class="s1">          next</span>
<span class="s1">      }</span>

<span class="s1">      {</span>
<span class="s1">          for (i=1;i&lt;=NF;i++) $i = trim($i)</span>
<span class="s1">          das     = $1</span>
<span class="s1">          refchan = $2</span>
<span class="s1">          refstrm = $3</span>
<span class="s1">          if (refstrm != 1) next</span>
<span class="s1">          key = das &quot;|&quot; refchan &quot;|&quot; refstrm</span>

<span class="s1">          if (!(key in has_expl)) {</span>
<span class="s1">              printf(&quot;[ERRO] Parfile exploratório não contém linha equivalente para %s|%s|%s\n&quot;,</span>
<span class="s1">                     das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">              next</span>
<span class="s1">          }</span>

<span class="s1">          tmpl_net   = $4</span>
<span class="s1">          tmpl_sta   = $5</span>
<span class="s1">          tmpl_loc   = $6</span>
<span class="s1">          tmpl_chan  = $7</span>
<span class="s1">          tmpl_sr    = $8</span>
<span class="s1">          tmpl_gain  = $9</span>
<span class="s1">          tmpl_itime = $10</span>

<span class="s1">          expl_net   = a_net[key]</span>
<span class="s1">          expl_sta   = a_sta[key]</span>
<span class="s1">          expl_loc   = a_loc[key]</span>
<span class="s1">          expl_chan  = a_chan[key]</span>
<span class="s1">          expl_sr    = a_sr[key]</span>
<span class="s1">          expl_gain  = a_gain[key]</span>
<span class="s1">          expl_itime = a_itime[key]</span>

<span class="s1">          low_tmpl_net = tolower(tmpl_net)</span>
<span class="s1">          low_expl_net = tolower(expl_net)</span>
<span class="s1">          if (!(low_tmpl_net == low_expl_net || low_expl_net == &quot;xx&quot;)) {</span>
<span class="s1">              printf(&quot;[ERRO] NETCODE difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_net, expl_net, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tolower(tmpl_sta) != tolower(expl_sta)) {</span>
<span class="s1">              printf(&quot;[ERRO] STATION difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_sta, expl_sta, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_loc != expl_loc) {</span>
<span class="s1">              printf(&quot;[ERRO] LOCATION difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_loc, expl_loc, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          low_tmpl_chan = tolower(tmpl_chan)</span>
<span class="s1">          low_expl_chan = tolower(expl_chan)</span>
<span class="s1">          chan_ok = 0</span>
<span class="s1">          if (low_tmpl_chan == low_expl_chan) {</span>
<span class="s1">              chan_ok = 1</span>
<span class="s1">          } else if ( (low_tmpl_chan==&quot;hhn&quot; &amp;&amp; low_expl_chan==&quot;hh1&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hh1&quot; &amp;&amp; low_expl_chan==&quot;hhn&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hhe&quot; &amp;&amp; low_expl_chan==&quot;hh2&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hh2&quot; &amp;&amp; low_expl_chan==&quot;hhe&quot;) ) {</span>
<span class="s1">              chan_ok = 1</span>
<span class="s1">          }</span>
<span class="s1">          if (!chan_ok) {</span>
<span class="s1">              printf(&quot;[ERRO] CHANNEL difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_chan, expl_chan, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_sr != expl_sr) {</span>
<span class="s1">              printf(&quot;[ERRO] SAMPLERATE difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_sr, expl_sr, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_gain != expl_gain) {</span>
<span class="s1">              printf(&quot;[ERRO] GAIN difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_gain, expl_gain, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_itime != expl_itime) {</span>
<span class="s1">              printf(&quot;[ERRO] IMPLEMENT_TIME difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_itime, expl_itime, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>
<span class="s1">      }</span>

<span class="s1">      END { exit erro }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_expl</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Compara <code class="docutils literal notranslate"><span class="pre">parfile.txt</span></code> gerado vs template <code class="docutils literal notranslate"><span class="pre">PARFILES/&lt;ESTACAO&gt;_parfile.txt</span></code>.</p>
<p>Regras-chave:</p>
<ul class="simple">
<li><p>cabeçalho deve ser idêntico</p></li>
<li><p>compara somente <code class="docutils literal notranslate"><span class="pre">refstrm</span> <span class="pre">==</span> <span class="pre">1</span></code></p></li>
<li><p>tolerâncias:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">NETCODE</span></code>: aceita equivalência case-insensitive e aceita exploratório <code class="docutils literal notranslate"><span class="pre">xx</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CHANNEL</span></code>: permite equivalência <code class="docutils literal notranslate"><span class="pre">HHN</span> <span class="pre">↔</span> <span class="pre">HH1</span></code> e <code class="docutils literal notranslate"><span class="pre">HHE</span> <span class="pre">↔</span> <span class="pre">HH2</span></code> (case-insensitive)</p></li>
</ul>
</li>
<li><p>outros campos (<code class="docutils literal notranslate"><span class="pre">STATION</span></code>, <code class="docutils literal notranslate"><span class="pre">LOC</span></code>, <code class="docutils literal notranslate"><span class="pre">SR</span></code>, <code class="docutils literal notranslate"><span class="pre">GAIN</span></code>, <code class="docutils literal notranslate"><span class="pre">IMPLEMENT_TIME</span></code>) devem bater</p></li>
</ul>
<p>Falhas geram <code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">!=</span> <span class="pre">0</span></code>, abortando o script (por <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-e</span></code> no chamador).</p>
</section>
<section id="resumir-auto-substituicoes-parfile">
<span id="sync-resumir-parfiles"></span><h3>11.2 <code class="docutils literal notranslate"><span class="pre">resumir_auto_substituicoes_parfile()</span></code><a class="headerlink" href="#resumir-auto-substituicoes-parfile" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-resumir-parfiles"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-resumir-parfiles"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">resumir_auto_substituicoes_parfile</span><a class="headerlink" href="#id21" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>resumir_auto_substituicoes_parfile<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">msg_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;Invalid network code (netcode&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="o">&amp;&amp;</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;Invalid channel name found&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • Substituições automáticas detectadas pelo rt2ms (modo exploratório):&quot;</span>

<span class="w">    </span>awk<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    /Invalid network code \(netcode = / {</span>
<span class="s1">        orig = $0</span>
<span class="s1">        net = orig</span>
<span class="s1">        sub(/.*Invalid network code \(netcode = /, &quot;&quot;, net)</span>
<span class="s1">        sub(/\).*/, &quot;&quot;, net)</span>

<span class="s1">        new = orig</span>
<span class="s1">        sub(/.*default one \(/, &quot;&quot;, new)</span>
<span class="s1">        sub(/\).*/, &quot;&quot;, new)</span>

<span class="s1">        printf(&quot;         - NETCODE: \&quot;%s\&quot; → \&quot;%s\&quot;\n&quot;, net, new)</span>
<span class="s1">    }</span>

<span class="s1">    /Invalid channel name found/ {</span>
<span class="s1">        orig = $0</span>
<span class="s1">        oldc = orig</span>
<span class="s1">        sub(/.*Invalid channel name found /, &quot;&quot;, oldc)</span>
<span class="s1">        sub(/\..*/, &quot;&quot;, oldc)</span>

<span class="s1">        newc = orig</span>
<span class="s1">        sub(/.*renaming channel as /, &quot;&quot;, newc)</span>
<span class="s1">        sub(/\..*/, &quot;&quot;, newc)</span>

<span class="s1">        printf(&quot;         - CHANNEL: \&quot;%s\&quot; → \&quot;%s\&quot;\n&quot;, oldc, newc)</span>
<span class="s1">    }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Lê <code class="docutils literal notranslate"><span class="pre">rt2ms.msg</span></code> e imprime no log um resumo humano quando o <code class="docutils literal notranslate"><span class="pre">rt2ms</span></code> tiver substituído automaticamente:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NETCODE</span></code> inválido → default</p></li>
<li><p>canal inválido → rename</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="fluxo-especifico-reftek-funcoes-auxiliares-de-inspecao-interna">
<h2>12) Fluxo específico: REFTEK (funções auxiliares de inspeção interna)<a class="headerlink" href="#fluxo-especifico-reftek-funcoes-auxiliares-de-inspecao-interna" title="Link permanente para este cabeçalho">#</a></h2>
<section id="find-reftek-dirs-stream1">
<span id="sync-find-reftek-dirs-stream1"></span><h3>12.1 <code class="docutils literal notranslate"><span class="pre">find_reftek_dirs_stream1()</span></code><a class="headerlink" href="#find-reftek-dirs-stream1" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-find-reftek-dirs-stream1"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-find-reftek-dirs-stream1"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">find_reftek_dirs_stream1</span><a class="headerlink" href="#id22" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find_reftek_dirs_stream1<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">args</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$root</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>first<span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-o<span class="w"> </span><span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
<span class="w">        </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-path<span class="w"> </span><span class="s2">&quot;*/</span><span class="nv">$c</span><span class="s2">/1&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">args</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Busca diretórios <code class="docutils literal notranslate"><span class="pre">*/&lt;DAS&gt;/1</span></code> abaixo de um root (tipicamente o <code class="docutils literal notranslate"><span class="pre">binary_dir</span></code>).</p>
<p>Uso: verificação de integridade horária (espera 24 arquivos por diretório-hora).</p>
</section>
<section id="find-reftek-files-stream0">
<span id="sync-find-reftek-files-stream0"></span><h3>12.2 <code class="docutils literal notranslate"><span class="pre">find_reftek_files_stream0()</span></code><a class="headerlink" href="#find-reftek-files-stream0" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-find-reftek-files-stream0"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-find-reftek-files-stream0"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">find_reftek_files_stream0</span><a class="headerlink" href="#id23" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find_reftek_files_stream0<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">args</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$root</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>first<span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-o<span class="w"> </span><span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
<span class="w">        </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-path<span class="w"> </span><span class="s2">&quot;*/</span><span class="nv">$c</span><span class="s2">/0/*&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">args</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Busca arquivos <code class="docutils literal notranslate"><span class="pre">*/&lt;DAS&gt;/0/*</span></code> (tipicamente logs SH) para extrair GPS e bateria.</p>
</section>
</section>
<hr class="docutils" />
<section id="fluxo-reftek-visao-de-blocos">
<h2>13) Fluxo REFTEK (visão de blocos)<a class="headerlink" href="#fluxo-reftek-visao-de-blocos" title="Link permanente para este cabeçalho">#</a></h2>
<section id="processar-reftek">
<span id="sync-processar-reftek"></span><h3>13.1 <code class="docutils literal notranslate"><span class="pre">processar_reftek()</span></code><a class="headerlink" href="#processar-reftek" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-processar-reftek"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-processar-reftek"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">processar_reftek</span><a class="headerlink" href="#id24" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>processar_reftek<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Iniciando processamento REFTEK para estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_first</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_first</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">julian_last</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="nv">$data</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">binary_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_BINARIES&quot;</span>

<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Criado diretório de binários: </span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Descompactando </span><span class="nv">$closest_zip</span><span class="s2"> → </span><span class="nv">$target_dir</span><span class="s2"> ...&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">ext_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_zip</span><span class="p">##*.</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ext_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ext_zip</span><span class="p">,,</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ext_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>zip<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-qq<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>rar<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span>run_cmd<span class="w"> </span>unrar<span class="w"> </span>x<span class="w"> </span>-inul<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>tar<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span>run_cmd<span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Tipo de arquivo &#39;</span><span class="nv">$ext_zip</span><span class="s2">&#39; não suportado.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>

<span class="w">    </span><span class="c1"># Descobre dirs DAS_CODE (um ou vários)</span>
<span class="w">    </span>split_das_codes<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">_CODES_SPLIT</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>source_dirs<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">        </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span><span class="se">\(</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">$(for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]:</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">printf</span><span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;-o -name %s &quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done)</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="se">\)</span>
<span class="w">    </span><span class="o">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">source_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum diretório </span><span class="si">${</span><span class="nv">codes</span><span class="p">[*]</span><span class="si">}</span><span class="s2"> encontrado em </span><span class="nv">$target_dir</span><span class="s2">. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>get_subrel_yjjj_das<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">src</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">rel</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">src</span><span class="p">#</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/&quot;</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>parts<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rel</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>i<span class="w"> </span>c
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span>i&lt;<span class="si">${#</span><span class="nv">parts</span><span class="p">[@]</span><span class="si">}</span>-1<span class="p">;</span><span class="w"> </span>i++<span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span><span class="m">0</span>-9<span class="o">]{</span><span class="m">7</span><span class="o">}([</span>_-<span class="o">]</span>.+<span class="o">)</span>?$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i+1]</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%s/%s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i+1]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">                    </span><span class="k">fi</span>
<span class="w">                </span><span class="k">done</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Movendo apenas a partir de YYYYJJJ/DASCODE/ para o BINARIES...&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>src
<span class="w">    </span><span class="k">for</span><span class="w"> </span>src<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">source_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>subrel
<span class="w">        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nv">subrel</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>get_subrel_yjjj_das<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Não consegui derivar subrel YYYYJJJ/DASCODE a partir de: </span><span class="nv">$src</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">            </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">/</span><span class="nv">$subrel</span><span class="s2">&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--remove-source-files<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span>/<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">/</span><span class="nv">$subrel</span><span class="s2">&quot;</span>/<span class="w"> </span>&gt;/dev/null
<span class="w">        </span>run_cmd<span class="w"> </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-empty<span class="w"> </span>-delete
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Todos os diretórios YYYYJJJ/DASCODE foram movidos para BINARIES.&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Verificando integridade horária...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>hour_dirs<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>find_reftek_dirs_stream1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>hour_dir
<span class="w">    </span><span class="k">for</span><span class="w"> </span>hour_dir<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hour_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>count_files
<span class="w">        </span><span class="nv">count_files</span><span class="o">=</span><span class="k">$(</span>ls<span class="w"> </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hour_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>raw_day_dir
<span class="w">        </span><span class="nv">raw_day_dir</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hour_dir</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">day_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_day_dir</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">7</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>count_files<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$day_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">year_first</span><span class="si">}${</span><span class="nv">julian_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$day_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">year_last</span><span class="si">}${</span><span class="nv">julian_last</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • BORDA DE COLETA: </span><span class="nv">$hour_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • ARQUIVOS INCOMPLETOS: </span><span class="nv">$hour_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extraindo informações de GPS/BATTERY/TEMP...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>info_files<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>find_reftek_files_stream0<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">info_files</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • [AVISO] Nenhum arquivo */DASCODE/0/* encontrado em </span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>info_file
<span class="w">        </span><span class="k">for</span><span class="w"> </span>info_file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">info_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span>awk<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">                /GPS:/ {</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0; getline;</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0; getline;</span>
<span class="s1">                }</span>
<span class="s1">                /BATTERY VOLTAGE/ {</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0;</span>
<span class="s1">                }</span>
<span class="s1">            &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_file</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_info.log&quot;</span>
<span class="w">        </span><span class="k">done</span>

<span class="w">        </span><span class="nv">info_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_info.log&quot;</span>

<span class="w">        </span>awk<span class="w"> </span><span class="s1">&#39;/GPS: POSITION:/ { print }&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_log</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-t<span class="s1">&#39;:&#39;</span><span class="w"> </span>-k1,1n<span class="w"> </span>-k2,2n<span class="w"> </span>-k3,3n<span class="w"> </span>-k4,4n<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.gps&quot;</span>

<span class="w">        </span>awk<span class="w"> </span><span class="s1">&#39;/BATTERY VOLTAGE/ { print }&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_log</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-t<span class="s1">&#39;:&#39;</span><span class="w"> </span>-k1,1n<span class="w"> </span>-k2,2n<span class="w"> </span>-k3,3n<span class="w"> </span>-k4,4n<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.battery&quot;</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • GPS e BATTERY extraídos e ordenados:&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;         - </span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.gps&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;         - </span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.battery&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Convertendo para MSEED (rt2ms_py3) e enviando ao SDS...&quot;</span>

<span class="w">      </span><span class="nv">RT2MS_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/python/rt2ms_py3&quot;</span>
<span class="w">      </span><span class="nv">CF_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>

<span class="w">      </span>run_cmd<span class="w"> </span>bash<span class="w"> </span>-lc<span class="w"> </span><span class="s2">&quot;cd &#39;</span><span class="nv">$target_dir</span><span class="s2">&#39; &amp;&amp; PYTHONPATH=&#39;</span><span class="nv">$RT2MS_ROOT</span><span class="s2">&#39; python3 -m rt2ms_py3.rt2ms_py3 -d &#39;</span><span class="nv">$CF_ROOT</span><span class="s2">&#39; -e&quot;</span>

<span class="w">      </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/parfile.txt&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] parfile.txt não foi gerado.&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">msg_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/rt2ms.msg&quot;</span>
<span class="w">      </span>resumir_auto_substituicoes_parfile<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span>

<span class="w">      </span><span class="nv">par_template</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PARFILES_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_parfile.txt&quot;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • Validando parfile.txt contra template: </span><span class="nv">$par_template</span><span class="s2">&quot;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>comparar_parfiles_com_tolerancia<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/parfile.txt&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="nb">echo</span>
<span class="w">              </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] O parfile gerado (parfile.txt) difere do template padrão fora dos limites permitidos.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">              </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">          </span><span class="k">fi</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • [AVISO] Template de parfile não encontrado em </span><span class="nv">$par_template</span><span class="s2">; prosseguindo sem validação.&quot;</span>
<span class="w">      </span><span class="k">fi</span>

<span class="w">      </span><span class="nv">outdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_code</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">.MSEED&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>bash<span class="w"> </span>-lc<span class="w"> </span><span class="s2">&quot;cd &#39;</span><span class="nv">$target_dir</span><span class="s2">&#39; &amp;&amp; PYTHONPATH=&#39;</span><span class="nv">$RT2MS_ROOT</span><span class="s2">&#39; python3 -m rt2ms_py3.rt2ms_py3 -d &#39;</span><span class="nv">$CF_ROOT</span><span class="s2">&#39; -p &#39;</span><span class="nv">$par_template</span><span class="s2">&#39; -o &#39;</span><span class="nv">$outdir</span><span class="s2">&#39;&quot;</span>

<span class="w">      </span><span class="nv">log_r2m_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_r2m.log&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span><span class="s2">&quot;/home/suporte/TMP/SYNC/python/dataselect/dataselect&quot;</span><span class="w"> </span>-Ps<span class="w"> </span>-SDS<span class="w"> </span>sds<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$outdir</span><span class="s2">&quot;</span>/<span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span>/*..HH?.*
<span class="w">      </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Processamento REFTEK concluído.&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Este bloco é executado quando <code class="docutils literal notranslate"><span class="pre">station_type=&quot;reftek&quot;</span></code> e o atalho “/sds/ no ZIP” não se aplica.</p>
<p>Etapas principais:</p>
<ol class="arabic simple">
<li><p><strong>Deriva intervalo de coleta</strong> a partir de <code class="docutils literal notranslate"><span class="pre">closest_date</span></code> e <code class="docutils literal notranslate"><span class="pre">last_date</span></code> e cria:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target_dir</span> <span class="pre">=</span> <span class="pre">$base_dir/&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">binary_dir</span> <span class="pre">=</span> <span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_BINARIES</span></code></p></li>
</ul>
</li>
<li><p><strong>Descompacta</strong> <code class="docutils literal notranslate"><span class="pre">closest_zip</span></code> em <code class="docutils literal notranslate"><span class="pre">target_dir</span></code> (zip/rar/tar).</p></li>
<li><p><strong>Move</strong> apenas a subárvore a partir de <code class="docutils literal notranslate"><span class="pre">YYYYJJJ/DASCODE/</span></code> para dentro de <code class="docutils literal notranslate"><span class="pre">binary_dir</span></code>:</p>
<ul class="simple">
<li><p>preserva <code class="docutils literal notranslate"><span class="pre">YYYYJJJ/DASCODE/...</span></code> dentro do BINARIES</p></li>
<li><p>remove diretórios vazios remanescentes</p></li>
</ul>
</li>
<li><p><strong>Checagem de integridade horária</strong>:</p>
<ul class="simple">
<li><p>varre <code class="docutils literal notranslate"><span class="pre">*/DAS/1</span></code></p></li>
<li><p>se <code class="docutils literal notranslate"><span class="pre">count_files</span> <span class="pre">!=</span> <span class="pre">24</span></code>, marca como:</p>
<ul>
<li><p>“BORDA DE COLETA” se for o primeiro/último dia do intervalo</p></li>
<li><p>“ARQUIVOS INCOMPLETOS” caso contrário</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Extração de GPS/BATTERY</strong> a partir de <code class="docutils literal notranslate"><span class="pre">*/DAS/0/*</span></code>:</p>
<ul class="simple">
<li><p>agrega em <code class="docutils literal notranslate"><span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_info.log</span></code></p></li>
<li><p>gera ordenados:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;.gps</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;.battery</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Conversão binário → miniSEED</strong> via <code class="docutils literal notranslate"><span class="pre">rt2ms_py3</span></code> em 2 fases:</p>
<ul class="simple">
<li><p>modo exploratório <code class="docutils literal notranslate"><span class="pre">-e</span></code> para gerar <code class="docutils literal notranslate"><span class="pre">parfile.txt</span></code> + <code class="docutils literal notranslate"><span class="pre">rt2ms.msg</span></code></p></li>
<li><p>valida <code class="docutils literal notranslate"><span class="pre">parfile.txt</span></code> contra template (se existir)</p></li>
<li><p>conversão final com <code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">template</span> <span class="pre">-o</span> <span class="pre">&lt;NET&gt;.&lt;ESTACAO&gt;.MSEED</span></code></p></li>
</ul>
</li>
<li><p><strong>Publicação em SDS local</strong> e pipeline SeisComP:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dataselect</span></code> (constrói <code class="docutils literal notranslate"><span class="pre">target_dir/sds</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sdsClone.py</span></code> (gera log de clone)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workthisout.sh</span> <span class="pre">--nostop</span></code> (publishes/organiza)</p></li>
</ul>
</li>
</ol>
<p>Saída operacional: SDS pronta em <code class="docutils literal notranslate"><span class="pre">target_dir/sds/</span></code>, logs prontos para consolidação em <code class="docutils literal notranslate"><span class="pre">finalizar_log</span></code>.</p>
</section>
</section>
<hr class="docutils" />
<section id="fluxo-raspberry-shake-visao-de-blocos">
<h2>14) Fluxo Raspberry Shake (visão de blocos)<a class="headerlink" href="#fluxo-raspberry-shake-visao-de-blocos" title="Link permanente para este cabeçalho">#</a></h2>
<section id="processar-raspberry">
<span id="sync-processar-raspberry"></span><h3>14.1 <code class="docutils literal notranslate"><span class="pre">processar_raspberry()</span></code><a class="headerlink" href="#processar-raspberry" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-processar-raspberry"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-processar-raspberry"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">processar_raspberry</span><a class="headerlink" href="#id25" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>processar_raspberry<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Iniciando processamento RASPBERRY para estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="nv">$julian_last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="nv">$data</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Listando arquivos no ZIP (</span><span class="nv">$closest_zip</span><span class="s2">) com dia ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2">...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>to_extract<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">        </span>unzip<span class="w"> </span>-Z1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">das</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">US</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span><span class="w"> </span>-F<span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">            index($0, &quot;/&quot; das &quot;/&quot;) &amp;&amp; match($NF, /[0-9]{4}\.[0-9]{3}$/) {</span>
<span class="s1">                split($NF, partes, &quot;.&quot;);</span>
<span class="s1">                if (partes[2] &gt;= US) print $0</span>
<span class="s1">            }&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="w">    </span><span class="o">)</span>

<span class="w">    </span><span class="o">[[</span><span class="w"> </span><span class="si">${#</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2"> encontrado. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extraindo </span><span class="si">${#</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> arquivos para </span><span class="nv">$target_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">MSEED_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_MSEED&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-qq<span class="w"> </span>-j<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Renomeando canais EH? → HH?...&quot;</span>
<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>chan<span class="w"> </span>file
<span class="w">    </span><span class="k">for</span><span class="w"> </span>chan<span class="w"> </span><span class="k">in</span><span class="w"> </span>EHZ<span class="w"> </span>EHN<span class="w"> </span>EHE<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span>*<span class="s2">&quot;</span><span class="nv">$chan</span><span class="s2">&quot;</span>*<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">newchan</span><span class="o">=</span><span class="s2">&quot;HH</span><span class="si">${</span><span class="nv">chan</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">newname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">file</span><span class="p">/.</span><span class="nv">$chan</span><span class="p">/.</span><span class="si">${</span><span class="nv">project_code</span><span class="si">}</span><span class="p">.</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="p">..</span><span class="nv">$newchan</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>msmod<span class="w"> </span>--net<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$project_code</span><span class="s2">&quot;</span><span class="w"> </span>--sta<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span>--loc<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>--chan<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$newchan</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$newname</span><span class="s2">&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>rm<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      → </span><span class="nv">$file</span><span class="s2"> → </span><span class="nv">$newname</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Enviando .mseed para SDS&quot;</span>
<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">        </span>run_cmd<span class="w"> </span>dataselect<span class="w"> </span>-Ps<span class="w"> </span>-Sd<span class="w"> </span>-A<span class="w"> </span>sds/%Y/%n/%s/%c.D/%n.%s.%l.%c.D.%Y.%j<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MSEED_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/*
<span class="w">        </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>-v<span class="w"> </span>log_r2m_file<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Processamento RASPBERRY concluído.&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Etapas principais:</p>
<ol class="arabic simple">
<li><p>Define <code class="docutils literal notranslate"><span class="pre">target_dir</span> <span class="pre">=</span> <span class="pre">$base_dir/&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;</span></code> (baseado em <code class="docutils literal notranslate"><span class="pre">last_date</span></code>).</p></li>
<li><p>Lista no ZIP apenas arquivos com <code class="docutils literal notranslate"><span class="pre">JJJ</span> <span class="pre">&gt;=</span> <span class="pre">ultimo_sinc</span></code> e extrai para:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MSEED_DIR</span> <span class="pre">=</span> <span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_MSEED</span></code></p></li>
</ul>
</li>
<li><p>Renomeia e corrige headers:</p>
<ul class="simple">
<li><p>canais <code class="docutils literal notranslate"><span class="pre">EHZ/EHN/EHE</span></code> → <code class="docutils literal notranslate"><span class="pre">HHZ/HHN/HHE</span></code></p></li>
<li><p>ajusta NET/STA/LOC/CHAN com <code class="docutils literal notranslate"><span class="pre">msmod</span></code></p></li>
<li><p>remove arquivo original após criar o novo nome</p></li>
</ul>
</li>
<li><p>Publica com:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dataselect</span></code> para <code class="docutils literal notranslate"><span class="pre">target_dir/sds/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sdsClone.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workthisout.sh</span> <span class="pre">--nostop</span></code></p></li>
</ul>
</li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="finalizacao-e-rastreabilidade-do-log">
<h2>15) Finalização e rastreabilidade do log<a class="headerlink" href="#finalizacao-e-rastreabilidade-do-log" title="Link permanente para este cabeçalho">#</a></h2>
<section id="finalizar-log">
<span id="sync-finalizar-log"></span><h3>15.1 <code class="docutils literal notranslate"><span class="pre">finalizar_log()</span></code><a class="headerlink" href="#finalizar-log" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-finalizar-log"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-finalizar-log"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">finalizar_log</span><a class="headerlink" href="#id26" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>finalizar_log<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>sds_size
<span class="w">        </span><span class="nv">sds_size</span><span class="o">=</span><span class="k">$(</span>du<span class="w"> </span>-sh<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/sds&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NA&quot;</span><span class="k">)</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">zip_ref</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_zip_orig</span><span class="k">:-</span><span class="nv">$closest_zip</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>md5sum_zip
<span class="w">        </span><span class="nv">md5sum_zip</span><span class="o">=</span><span class="k">$(</span>md5sum<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>zip_size
<span class="w">        </span><span class="nv">zip_size</span><span class="o">=</span><span class="k">$(</span>du<span class="w"> </span>-sh<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ MD5 do </span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">: </span><span class="nv">$md5sum_zip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Tamanho do ZIP: </span><span class="nv">$zip_size</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Tamanho do SDS: </span><span class="nv">$sds_size</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>hora_minuto
<span class="w">        </span><span class="nv">hora_minuto</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%H%M<span class="k">)</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">new_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">_sync.log&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Log sincronização renomeado para: </span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="c1"># chave de associação: mesmo prefixo do _sync.log</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="c1"># move RT130_*.log para LOGS/ com o mesmo prefixo</span>
<span class="w">        </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">rtlogs</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/LOGS&quot;</span>/RT130_*.log<span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="nb">shopt</span><span class="w"> </span>-u<span class="w"> </span>nullglob

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">rtlogs</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>&gt;<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>rt
<span class="w">            </span><span class="k">for</span><span class="w"> </span>rt<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">rtlogs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="nb">local</span><span class="w"> </span><span class="nv">b</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rt</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">                </span>run_cmd<span class="w"> </span>mv<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rt</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">b</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">done</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">log_r2m_file</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_r2m_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">new_r2m</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">_r2m.log&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_r2m_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_r2m</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Log r2m renomeado para: </span><span class="nv">$new_r2m</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização concluída em: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARN] Arquivo de log &#39;</span><span class="nv">$log_file</span><span class="s2">&#39; não encontrado.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Consolida o log e cria uma chave única da execução:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">=</span> <span class="pre">&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_&lt;HHMM&gt;</span></code></p></li>
</ul>
<p>Ações:</p>
<ol class="arabic simple">
<li><p>calcula e registra no log:</p>
<ul class="simple">
<li><p>tamanho do <code class="docutils literal notranslate"><span class="pre">target_dir/sds</span></code> (se existir)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">md5sum</span></code> e tamanho do pacote de entrada (preferindo <code class="docutils literal notranslate"><span class="pre">closest_zip_orig</span></code>)</p></li>
</ul>
</li>
<li><p>renomeia o log principal:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LOGS/&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_&lt;HHMM&gt;_sync.log</span></code></p></li>
</ul>
</li>
<li><p>move anexos RT130:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target_dir/LOGS/RT130_*.log</span></code> → <code class="docutils literal notranslate"><span class="pre">LOGS/&lt;key&gt;_RT130_....log</span></code></p></li>
</ul>
</li>
<li><p>renomeia o log r2m (se existir):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LOGS/&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_&lt;HHMM&gt;_r2m.log</span></code></p></li>
</ul>
</li>
<li><p>grava timestamp final “Sincronização concluída”.</p></li>
</ol>
</section>
</section>
<hr class="docutils" />
<section id="bloco-config-main-controle-do-fluxo">
<h2>16) Bloco CONFIG + MAIN (controle do fluxo)<a class="headerlink" href="#bloco-config-main-controle-do-fluxo" title="Link permanente para este cabeçalho">#</a></h2>
<section id="configuracao-de-diretorios-e-log">
<span id="sync-config-logging"></span><h3>16.1 Configuração de diretórios e log<a class="headerlink" href="#configuracao-de-diretorios-e-log" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-config-logging"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-config-logging"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">Configuração de diretórios e log</span><a class="headerlink" href="#id27" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span>
<span class="nv">base_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/TMP/SYNC&quot;</span>
<span class="nv">log_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/LOGS&quot;</span>
<span class="nv">PARFILES_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/PARFILES/&quot;</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">&quot;</span>
<span class="nv">log_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/test.log&quot;</span>
:<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="nb">exec</span><span class="w"> </span>&gt;<span class="w"> </span>&gt;<span class="o">(</span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="o">)</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização iniciada em: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<p>Define o ambiente de execução:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">base_dir=&quot;$HOME/TMP/SYNC&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_dir=&quot;$base_dir/LOGS&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PARFILES_DIR=&quot;$base_dir/PARFILES/&quot;</span></code></p></li>
</ul>
<p>E ativa o <em>capture</em> integral:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">exec</span> <span class="pre">&gt;</span> <span class="pre">&gt;(tee</span> <span class="pre">-a</span> <span class="pre">&quot;$log_file&quot;)</span> <span class="pre">2&gt;&amp;1</span></code></p></li>
</ul>
<p>A partir daqui, <strong>tudo</strong> que o script imprime vai para o arquivo e para o stdout.</p>
</section>
<section id="cli-e-modos-de-execucao">
<span id="sync-cli-usage"></span><h3>16.2 CLI e modos de execução<a class="headerlink" href="#cli-e-modos-de-execucao" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-cli-usage"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-cli-usage"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">CLI usage</span><a class="headerlink" href="#id28" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">Uso: $0 [opções]</span>

<span class="s">  -p PROJETO   Nome exato do projeto (por ex: &quot;BAESA ENERCAN&quot;)</span>
<span class="s">  -e ESTAÇÃO   Código da estação (por ex: &quot;BC4&quot;)</span>
<span class="s">  -y ANO       (opcional) Ano para procurar o último sincronizado (YYYY).</span>
<span class="s">               Se omitido, tenta ano atual e ano anterior.</span>
<span class="s">  -f           Força sincronização (ignora último dia na SDS)</span>
<span class="s">  -h           Exibe esta ajuda</span>

<span class="s">Exemplos:</span>
<span class="s">  $0 -p &quot;MACHADINHO&quot; -e &quot;MC9&quot;</span>
<span class="s">  $0 -p &quot;ITA&quot; -e &quot;IT1&quot; -y 2024</span>
<span class="s">  $0</span>
<span class="s">EOF</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p id="sync-cli-getopts">[<a class="reference internal" href="api/sync.html#api-sync-cli-getopts"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-cli-getopts"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">CLI getopts</span><a class="headerlink" href="#id29" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="nb">getopts</span><span class="w"> </span><span class="s2">&quot;:p:e:y:hf&quot;</span><span class="w"> </span>opt<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$opt</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>p<span class="o">)</span><span class="w"> </span><span class="nv">PROJETO_ESCOLHIDO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>e<span class="o">)</span><span class="w"> </span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>y<span class="o">)</span><span class="w"> </span><span class="nv">ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>f<span class="o">)</span><span class="w"> </span><span class="nv">FORCE_SYNC</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>h<span class="o">)</span><span class="w"> </span>usage<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span><span class="w"> </span>usage<span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="k">esac</span>
<span class="k">done</span>
<span class="nb">shift</span><span class="w"> </span><span class="k">$((</span><span class="nv">OPTIND</span><span class="w"> </span><span class="o">-</span><span class="m">1</span><span class="k">))</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">usage()</span></code> define flags:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-p</span></code> projeto, <code class="docutils literal notranslate"><span class="pre">-e</span></code> estação</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-y</span></code> ano forçado</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-f</span></code> força sync</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-h</span></code> ajuda</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">getopts</span></code> popula variáveis globais.</p></li>
</ul>
</section>
<section id="selecao-do-contexto">
<span id="sync-select-context"></span><h3>16.3 Seleção do contexto<a class="headerlink" href="#selecao-do-contexto" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-select-context"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-select-context"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">Seleção do contexto</span><a class="headerlink" href="#id30" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">found</span><span class="o">=</span><span class="m">0</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>key<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!projects[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>p<span class="w"> </span>e<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">found</span><span class="o">=</span><span class="m">1</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$found</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Combinação PROJETO=&#39;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&#39; e ESTAÇÃO=&#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não encontrada.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_map</span><span class="p">[</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_codes</span><span class="p">[</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="c1"># &gt;&gt;&gt; FIX CRÍTICO: code_pattern também no modo -p/-e</span>
<span class="w">  </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">reftek_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;reftek&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Reftek.&quot;</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raspberry_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;raspberry&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Raspberry Shake.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Estação &#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não pertence a nenhuma lista conhecida.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">else</span>
<span class="w">  </span>seleciona_projeto_estacao
<span class="k">fi</span>
</pre></div>
</div>
</div>
<p>Caso <code class="docutils literal notranslate"><span class="pre">-p</span></code> e <code class="docutils literal notranslate"><span class="pre">-e</span></code> tenham sido fornecidos:</p>
<ol class="arabic simple">
<li><p>valida se a combinação existe em <code class="docutils literal notranslate"><span class="pre">projects</span></code></p></li>
<li><p>define <code class="docutils literal notranslate"><span class="pre">project_code</span></code>, <code class="docutils literal notranslate"><span class="pre">das_code</span></code>, <code class="docutils literal notranslate"><span class="pre">origin_dir</span></code></p></li>
<li><p><strong>define <code class="docutils literal notranslate"><span class="pre">code_pattern</span></code></strong></p></li>
<li><p>define <code class="docutils literal notranslate"><span class="pre">station_type</span></code> por pertencimento em listas</p></li>
</ol>
<p>Caso contrário, cai no modo interativo:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">seleciona_projeto_estacao</span></code></p></li>
</ul>
</section>
<section id="ano-forcado">
<span id="sync-ano-forcado"></span><h3>16.4 Ano forçado<a class="headerlink" href="#ano-forcado" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-ano-forcado"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-ano-forcado"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">Ano forçado</span><a class="headerlink" href="#id31" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>log_debug<span class="w"> </span><span class="s2">&quot;Ano forçado: </span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span><span class="nv">_SHA_ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">function</span><span class="w"> </span>obter_ultimo_sinc<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">ano</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$_SHA_ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">sds_dir</span><span class="o">=</span><span class="s2">&quot;/SDS/</span><span class="nv">$ano</span><span class="s2">/</span><span class="nv">$project_code</span><span class="s2">/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">/HHZ.D&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Diretório &#39;</span><span class="nv">$sds_dir</span><span class="s2">&#39; não existe para o ano forçado </span><span class="nv">$ano</span><span class="s2">.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>last_file
<span class="w">    </span><span class="nv">last_file</span><span class="o">=</span><span class="k">$(</span>
<span class="w">        </span>ls<span class="w"> </span>-1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1
<span class="w">    </span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo &#39;*.YYYYJJJ&#39; em &#39;</span><span class="nv">$sds_dir</span><span class="s2">&#39;.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ano</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Último dia sincronizado na SDS (</span><span class="nv">$sds_dir</span><span class="s2">): </span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<p>Se <code class="docutils literal notranslate"><span class="pre">ANO_FORCADO</span></code> foi definido, o script <strong>redefine</strong> (override) a função <code class="docutils literal notranslate"><span class="pre">obter_ultimo_sinc()</span></code> para usar exclusivamente:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/SDS/&lt;ANO_FORCADO&gt;/&lt;REDE&gt;/&lt;ESTACAO&gt;/HHZ.D</span></code></p></li>
</ul>
<p>Isso substitui a lógica “ano atual e anterior”.</p>
</section>
<section id="execucao-da-selecao-automatica">
<span id="sync-auto-selection"></span><h3>16.5 Execução da seleção automática<a class="headerlink" href="#execucao-da-selecao-automatica" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-auto-selection"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-auto-selection"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">Seleção automática</span><a class="headerlink" href="#id32" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>obter_ultimo_sinc
encontrar_closest_zip
</pre></div>
</div>
</div>
<p>Sequência fixa:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">obter_ultimo_sinc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">encontrar_closest_zip</span></code></p></li>
</ol>
<p>Após isso, o script tem:</p>
<ul class="simple">
<li><p>qual pacote usar (<code class="docutils literal notranslate"><span class="pre">closest_zip</span></code>)</p></li>
<li><p>qual intervalo de datas ele cobre (<code class="docutils literal notranslate"><span class="pre">closest_date</span></code> → <code class="docutils literal notranslate"><span class="pre">last_date</span></code>)</p></li>
<li><p>qual o último sincronizado (<code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span></code>)</p></li>
</ul>
</section>
<section id="atalho-reftek-pacote-ja-contem-sds">
<span id="sync-reftek-shortcut"></span><h3>16.6 Atalho REFTEK: pacote já contém <code class="docutils literal notranslate"><span class="pre">/sds/</span></code><a class="headerlink" href="#atalho-reftek-pacote-ja-contem-sds" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-reftek-shortcut"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-reftek-shortcut"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">Atalho REFTEK com SDS</span><a class="headerlink" href="#id33" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Atalho: se ZIP já vier com /sds/ (Reftek), apenas extrai e publica</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;reftek&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">local_year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">local_julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$local_year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">local_julian_last</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">mseed_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_MSEED&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>unzip<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;NR&gt;3 &amp;&amp; NF&gt;=4 {print $4}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;/sds/&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ ZIP já vem em SDS/MiniSEED; extraindo em </span><span class="nv">$target_dir</span><span class="s2"> e pulando reftek2mseed&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-j<span class="w"> </span>-qq<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="nv">$mseed_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Dataselect ...&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>dataselect<span class="w"> </span>-Ps<span class="w"> </span>-Sd<span class="w"> </span>-A<span class="w"> </span>sds/%Y/%n/%s/%c.D/%n.%s.%l.%c.D.%Y.%j<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$mseed_dir</span><span class="s2">&quot;</span>/*
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - sdsClone.py ...&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span>finalizar_log
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<p>Se <code class="docutils literal notranslate"><span class="pre">station_type=reftek</span></code> e o <code class="docutils literal notranslate"><span class="pre">closest_zip</span></code> contém paths com <code class="docutils literal notranslate"><span class="pre">/sds/</span></code>:</p>
<ol class="arabic simple">
<li><p>extrai os miniSEED em <code class="docutils literal notranslate"><span class="pre">target_dir/&lt;ESTACAO&gt;_&lt;YYYYMMDD&gt;_MSEED</span></code></p></li>
<li><p>publica direto com <code class="docutils literal notranslate"><span class="pre">dataselect</span></code> + <code class="docutils literal notranslate"><span class="pre">sdsClone.py</span></code> + <code class="docutils literal notranslate"><span class="pre">workthisout.sh</span></code></p></li>
<li><p>roda <code class="docutils literal notranslate"><span class="pre">finalizar_log</span></code> e encerra (<code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">0</span></code>)</p></li>
</ol>
<p><strong>Finalidade do atalho:</strong> pular a conversão binária quando o pacote já vem “pronto”.</p>
</section>
<section id="dispatch-final-e-encerramento">
<span id="sync-dispatch"></span><h3>16.7 Dispatch final e encerramento<a class="headerlink" href="#dispatch-final-e-encerramento" title="Link permanente para este cabeçalho">#</a></h3>
<p>[<a class="reference internal" href="api/sync.html#api-sync-dispatch"><span class="std std-ref">api</span></a>] | [<a class="reference internal" href="_modules/SYNC.sh.html#src-sync-dispatch"><span class="std std-ref">source</span></a>]</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">Dispatch final</span><a class="headerlink" href="#id34" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dispatch_processing<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>reftek<span class="o">)</span><span class="w"> </span>processar_reftek<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>raspberry<span class="o">)</span><span class="w"> </span>processar_raspberry<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Tipo de estação desconhecido: </span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="k">esac</span>
<span class="o">}</span>

dispatch_processing
finalizar_log
<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
</div>
<p>Se não caiu no atalho:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dispatch_processing()</span></code> chama:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">processar_reftek</span></code> ou <code class="docutils literal notranslate"><span class="pre">processar_raspberry</span></code></p></li>
</ul>
</li>
<li><p>depois chama <code class="docutils literal notranslate"><span class="pre">finalizar_log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">0</span></code></p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="glossario-rapido-das-variaveis-que-amarram-o-fluxo">
<h2>17) Glossário rápido das variáveis que “amarram” o fluxo<a class="headerlink" href="#glossario-rapido-das-variaveis-que-amarram-o-fluxo" title="Link permanente para este cabeçalho">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_code</span></code>: rede SDS (BC/BL/IT/MC/SP)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">das_code</span></code>: código(s) de origem (um ou mais)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">code_pattern</span></code>: <code class="docutils literal notranslate"><span class="pre">das_code</span></code> convertido para <code class="docutils literal notranslate"><span class="pre">A|B|C</span></code> (uso em extração REFTEK)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span></code>: último <code class="docutils literal notranslate"><span class="pre">JJJ</span></code> encontrado em <code class="docutils literal notranslate"><span class="pre">/SDS/.../HHZ.D</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip</span></code>: arquivo compactado escolhido (já “normalizado” se era <code class="docutils literal notranslate"><span class="pre">.zip.bz2</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip_orig</span></code>: referência ao arquivo original (para MD5 e tamanho)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_date</span></code>, <code class="docutils literal notranslate"><span class="pre">last_date</span></code>: <code class="docutils literal notranslate"><span class="pre">YYYYJJJ</span></code> do primeiro e último dia “novo” no pacote</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_dir</span></code>: diretório de trabalho por execução</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log_file</span></code>: log da execução (renomeado ao final)</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="limites-e-garantias-do-fluxo-geral">
<h2>18) Limites e garantias do fluxo geral<a class="headerlink" href="#limites-e-garantias-do-fluxo-geral" title="Link permanente para este cabeçalho">#</a></h2>
<p>Garantias que o <code class="docutils literal notranslate"><span class="pre">main</span></code> tenta manter antes de iniciar o processamento específico:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project_code</span></code>, <code class="docutils literal notranslate"><span class="pre">das_code</span></code>, <code class="docutils literal notranslate"><span class="pre">station_type</span></code> definidos e válidos</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">code_pattern</span></code> não vazio (necessário para REFTEK)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ultimo_sinc</span></code> obtido com regra clara (ano atual/anterior ou <code class="docutils literal notranslate"><span class="pre">-y</span></code>, ou <code class="docutils literal notranslate"><span class="pre">-f</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">closest_zip</span></code> escolhido por um critério determinístico (menor diff, desempate por maior alcance)</p></li>
</ul>
<p>Qualquer quebra de uma dessas garantias termina em <code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">1</span></code> com log detalhado.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="api/sync.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">SYNC.sh — API/Reference</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="guia_operador.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">guia_operador</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Gabriel Góes Rocha de Lima
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Visão geral do fluxo (<code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>)</a><ul>
<li><a class="reference internal" href="#objetivo-operacional-do-script">0) Objetivo operacional do script</a></li>
<li><a class="reference internal" href="#regras-globais-de-robustez-e-rastreabilidade">1) Regras globais de robustez e rastreabilidade</a><ul>
<li><a class="reference internal" href="#set-euo-pipefail">1.1 <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-euo</span> <span class="pre">pipefail</span></code></a></li>
<li><a class="reference internal" href="#run-cmd">1.2 <code class="docutils literal notranslate"><span class="pre">run_cmd()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#inventario-estatico-estacoes-das-codes-e-projetos">2) Inventário estático: estações, DAS codes e projetos</a><ul>
<li><a class="reference internal" href="#listas-por-tipo">2.1 Listas por tipo</a></li>
<li><a class="reference internal" href="#das-codes">2.2 <code class="docutils literal notranslate"><span class="pre">das_codes</span></code></a></li>
<li><a class="reference internal" href="#projects-project-map">2.3 <code class="docutils literal notranslate"><span class="pre">projects</span></code> + <code class="docutils literal notranslate"><span class="pre">project_map</span></code></a></li>
<li><a class="reference internal" href="#futura-expansao">2.4 Futura expansão</a></li>
</ul>
</li>
<li><a class="reference internal" href="#variaveis-globais-para-compatibilidade-com-set-u">3) Variáveis globais (para compatibilidade com <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-u</span></code>)</a><ul>
<li><a class="reference internal" href="#globais-inicializadas-com-string-vazia">3.1 Globais inicializadas com string vazia</a></li>
</ul>
</li>
<li><a class="reference internal" href="#suporte-a-multiplos-das-code">4) Suporte a múltiplos DAS_CODE</a><ul>
<li><a class="reference internal" href="#build-code-pattern">4.1 <code class="docutils literal notranslate"><span class="pre">build_code_pattern()</span></code></a></li>
<li><a class="reference internal" href="#split-das-codes">4.2 <code class="docutils literal notranslate"><span class="pre">split_das_codes()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#funcoes-utilitarias-gerais">5) Funções utilitárias gerais</a><ul>
<li><a class="reference internal" href="#log-debug">5.1 <code class="docutils literal notranslate"><span class="pre">log_debug()</span></code></a></li>
<li><a class="reference internal" href="#dia-juliano">5.2 <code class="docutils literal notranslate"><span class="pre">dia_juliano()</span></code></a></li>
<li><a class="reference internal" href="#is-station-in-list">5.3 <code class="docutils literal notranslate"><span class="pre">is_station_in_list()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#selecao-projeto-estacao-modo-interativo">6) Seleção Projeto/Estação (modo interativo)</a><ul>
<li><a class="reference internal" href="#seleciona-projeto-estacao">6.1 <code class="docutils literal notranslate"><span class="pre">seleciona_projeto_estacao()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#determinar-o-ultimo-sincronizado-na-sds">7) Determinar o último sincronizado na SDS</a><ul>
<li><a class="reference internal" href="#obter-ultimo-sinc">7.1 <code class="docutils literal notranslate"><span class="pre">obter_ultimo_sinc()</span></code></a><ul>
<li><a class="reference internal" href="#caso-a-sincronizacao-forcada-com-opcao-f-force-sync-1">Caso A — sincronização forçada com opção -f (<code class="docutils literal notranslate"><span class="pre">FORCE_SYNC=1</span></code>)</a></li>
<li><a class="reference internal" href="#caso-b-regra-padrao">Caso B — regra padrão</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#suporte-a-arquivos-compactados-e-listagem-de-paths-internos">8) Suporte a arquivos compactados e listagem de paths internos</a><ul>
<li><a class="reference internal" href="#prepare-archive">8.1 <code class="docutils literal notranslate"><span class="pre">prepare_archive()</span></code></a></li>
<li><a class="reference internal" href="#list-archive-paths">8.2 <code class="docutils literal notranslate"><span class="pre">list_archive_paths()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#extracao-de-datas-internas-do-pacote">9) Extração de “datas internas” do pacote</a><ul>
<li><a class="reference internal" href="#raspberry-extract-dates-from-rasp">9.1 Raspberry: <code class="docutils literal notranslate"><span class="pre">extract_dates_from_rasp()</span></code></a></li>
<li><a class="reference internal" href="#reftek-qualquer-profundidade-extract-reftek-dates-any-depth">9.2 REFTEK (qualquer profundidade): <code class="docutils literal notranslate"><span class="pre">extract_reftek_dates_any_depth()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#selecao-automatica-do-pacote-closest">10) Seleção automática do pacote “closest”</a><ul>
<li><a class="reference internal" href="#encontrar-closest-zip">10.1 <code class="docutils literal notranslate"><span class="pre">encontrar_closest_zip()</span></code></a><ul>
<li><a class="reference internal" href="#inicializacao">10.1.1 Inicialização</a></li>
<li><a class="reference internal" href="#loop-por-arquivo">10.1.2 Loop por arquivo</a></li>
<li><a class="reference internal" href="#resultado-consolidado">10.1.3 Resultado consolidado</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#validacao-e-tolerancias-do-parfile-bloco-transversal-do-reftek">11) Validação e tolerâncias do <code class="docutils literal notranslate"><span class="pre">parfile</span></code> (bloco transversal do REFTEK)</a><ul>
<li><a class="reference internal" href="#comparar-parfiles-com-tolerancia">11.1 <code class="docutils literal notranslate"><span class="pre">comparar_parfiles_com_tolerancia()</span></code></a></li>
<li><a class="reference internal" href="#resumir-auto-substituicoes-parfile">11.2 <code class="docutils literal notranslate"><span class="pre">resumir_auto_substituicoes_parfile()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#fluxo-especifico-reftek-funcoes-auxiliares-de-inspecao-interna">12) Fluxo específico: REFTEK (funções auxiliares de inspeção interna)</a><ul>
<li><a class="reference internal" href="#find-reftek-dirs-stream1">12.1 <code class="docutils literal notranslate"><span class="pre">find_reftek_dirs_stream1()</span></code></a></li>
<li><a class="reference internal" href="#find-reftek-files-stream0">12.2 <code class="docutils literal notranslate"><span class="pre">find_reftek_files_stream0()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#fluxo-reftek-visao-de-blocos">13) Fluxo REFTEK (visão de blocos)</a><ul>
<li><a class="reference internal" href="#processar-reftek">13.1 <code class="docutils literal notranslate"><span class="pre">processar_reftek()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#fluxo-raspberry-shake-visao-de-blocos">14) Fluxo Raspberry Shake (visão de blocos)</a><ul>
<li><a class="reference internal" href="#processar-raspberry">14.1 <code class="docutils literal notranslate"><span class="pre">processar_raspberry()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#finalizacao-e-rastreabilidade-do-log">15) Finalização e rastreabilidade do log</a><ul>
<li><a class="reference internal" href="#finalizar-log">15.1 <code class="docutils literal notranslate"><span class="pre">finalizar_log()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#bloco-config-main-controle-do-fluxo">16) Bloco CONFIG + MAIN (controle do fluxo)</a><ul>
<li><a class="reference internal" href="#configuracao-de-diretorios-e-log">16.1 Configuração de diretórios e log</a></li>
<li><a class="reference internal" href="#cli-e-modos-de-execucao">16.2 CLI e modos de execução</a></li>
<li><a class="reference internal" href="#selecao-do-contexto">16.3 Seleção do contexto</a></li>
<li><a class="reference internal" href="#ano-forcado">16.4 Ano forçado</a></li>
<li><a class="reference internal" href="#execucao-da-selecao-automatica">16.5 Execução da seleção automática</a></li>
<li><a class="reference internal" href="#atalho-reftek-pacote-ja-contem-sds">16.6 Atalho REFTEK: pacote já contém <code class="docutils literal notranslate"><span class="pre">/sds/</span></code></a></li>
<li><a class="reference internal" href="#dispatch-final-e-encerramento">16.7 Dispatch final e encerramento</a></li>
</ul>
</li>
<li><a class="reference internal" href="#glossario-rapido-das-variaveis-que-amarram-o-fluxo">17) Glossário rápido das variáveis que “amarram” o fluxo</a></li>
<li><a class="reference internal" href="#limites-e-garantias-do-fluxo-geral">18) Limites e garantias do fluxo geral</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/translations.js"></script>
    <script src="_static/design-tabs.js"></script>
    </body>
</html>