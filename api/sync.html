<!doctype html>
<html class="no-js" lang="pt-BR">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Índice" href="../genindex.html" /><link rel="search" title="Buscar" href="../search.html" /><link rel="next" title="SYNC.sh — source" href="../_modules/SYNC.sh.html" /><link rel="prev" title="Visão geral do fluxo (SYNC.sh)" href="../visao_geral_do_fluxo.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>SYNC.sh — API/Reference - documentação SYNC - Sincronização SDS 0.1.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">documentação SYNC - Sincronização SDS 0.1.0</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">documentação SYNC - Sincronização SDS 0.1.0</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Buscar" name="q" aria-label="Buscar">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../guia_rapido.html">Guia rápido</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guia_operador.html">guia_operador</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visao_geral_do_fluxo.html">Visão geral do fluxo (<code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>)</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">SYNC.sh — API/Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_modules/SYNC.sh.html">SYNC.sh — source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fluxo_reftek.html">fluxo_reftek</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fluxo_raspberry.html">fluxo_raspberry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../estrutura_diretorios.html">estrutura_diretorios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flags_cli.html">flags_cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logs_e_rastreabilidade.html">logs_e_rastreabilidade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencias.html">dependencias</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="sync-sh-api-reference">
<h1>SYNC.sh — API/Reference<a class="headerlink" href="#sync-sh-api-reference" title="Link permanente para este cabeçalho">#</a></h1>
<p>Esta seção descreve os principais blocos e funções do <code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>, com links bidirecionais para o código-fonte renderizado.</p>
<section id="modo-estrito-set-euo-pipefail-source-src-sync-strict-mode">
<span id="api-sync-strict-mode"></span><h2>Modo estrito (<code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-euo</span> <span class="pre">pipefail</span></code>) ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-strict-mode"><span class="std std-ref">Modo estrito (set -euo pipefail) ([docs]sync-strict-mode)</span></a>)<a class="headerlink" href="#modo-estrito-set-euo-pipefail-source-src-sync-strict-mode" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Modo estrito do shell</span><a class="headerlink" href="#id1" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</pre></div>
</div>
</div>
</section>
<section id="run-cmd-source-src-sync-run-cmd">
<span id="api-sync-run-cmd"></span><h2>run_cmd ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-run-cmd"><span class="std std-ref">run_cmd ([docs]sync-run-cmd)</span></a>)<a class="headerlink" href="#run-cmd-source-src-sync-run-cmd" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Função run_cmd</span><a class="headerlink" href="#id2" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>run_cmd<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">cmd</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">cmd</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">status</span><span class="o">=</span><span class="nv">$?</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] [ERROR] Comando &#39;</span><span class="si">${</span><span class="nv">cmd</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&#39; retornou </span><span class="nv">$status</span><span class="s2">.&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$status</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="listas-de-estacoes-source-src-sync-station-lists">
<span id="api-sync-station-lists"></span><h2>Listas de estações ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-station-lists"><span class="std std-ref">Listas de estações ([docs]sync-station-lists)</span></a>)<a class="headerlink" href="#listas-de-estacoes-source-src-sync-station-lists" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Listas de estações</span><a class="headerlink" href="#id3" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">reftek_stations</span><span class="o">=(</span>PRB1<span class="w"> </span>BC9<span class="w"> </span>BC4<span class="w"> </span>BCM2<span class="w"> </span>SP7<span class="w"> </span>IT1<span class="o">)</span>
<span class="nb">declare</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">raspberry_stations</span><span class="o">=(</span>MC9<span class="w"> </span>IT9<span class="o">)</span>
</pre></div>
</div>
</div>
</section>
<section id="das-codes-source-src-sync-das-codes">
<span id="api-sync-das-codes"></span><h2>das_codes ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-das-codes"><span class="std std-ref">das_codes ([docs]sync-das-codes)</span></a>)<a class="headerlink" href="#das-codes-source-src-sync-das-codes" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Mapa de DAS codes</span><a class="headerlink" href="#id4" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">das_codes</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span>BCM2<span class="o">]=</span>AD19
<span class="w">    </span><span class="o">[</span>PRB1<span class="o">]=</span><span class="s2">&quot;AD20&quot;</span><span class="w">   </span><span class="c1"># suporte a múltiplos códigos: basta separar por espaço (ex: &quot;AD20 9789&quot;)</span>
<span class="w">    </span><span class="o">[</span>BC9<span class="o">]=</span><span class="m">9690</span>
<span class="w">    </span><span class="o">[</span>SP7<span class="o">]=</span>9FD3
<span class="w">    </span><span class="o">[</span>IT1<span class="o">]=</span>B438
<span class="w">    </span><span class="o">[</span>BC4<span class="o">]=</span><span class="m">9775</span>
<span class="w">    </span><span class="o">[</span>MC9<span class="o">]=</span>REDD8
<span class="w">    </span><span class="o">[</span>IT9<span class="o">]=</span>REDD8
</pre></div>
</div>
</div>
</section>
<section id="projects-source-src-sync-projects">
<span id="api-sync-projects"></span><h2>projects ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-projects"><span class="std std-ref">projects ([docs]sync-projects)</span></a>)<a class="headerlink" href="#projects-source-src-sync-projects" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Lista de projetos</span><a class="headerlink" href="#id5" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">projects</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span><span class="m">1</span><span class="o">]=</span><span class="s2">&quot;BAESA ENERCAN|BC4&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">2</span><span class="o">]=</span><span class="s2">&quot;BAESA ENERCAN|BC9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">3</span><span class="o">]=</span><span class="s2">&quot;PARAIBUNA|PRB1&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">4</span><span class="o">]=</span><span class="s2">&quot;ITA|IT9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">5</span><span class="o">]=</span><span class="s2">&quot;ITA|IT1&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">6</span><span class="o">]=</span><span class="s2">&quot;MACHADINHO|BCM2&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">7</span><span class="o">]=</span><span class="s2">&quot;MACHADINHO|MC9&quot;</span>
<span class="w">    </span><span class="o">[</span><span class="m">8</span><span class="o">]=</span><span class="s2">&quot;SALTO PILAO|SP7&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="project-map-source-src-sync-project-map">
<span id="api-sync-project-map"></span><h2>project_map ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-project-map"><span class="std std-ref">project_map ([docs]sync-project-map)</span></a>)<a class="headerlink" href="#project-map-source-src-sync-project-map" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Mapa de projetos</span><a class="headerlink" href="#id6" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span><span class="nv">project_map</span><span class="o">=(</span>
<span class="w">    </span><span class="o">[</span><span class="s2">&quot;BAESA ENERCAN&quot;</span><span class="o">]=</span>BC
<span class="w">    </span><span class="o">[</span>PARAIBUNA<span class="o">]=</span>BL
<span class="w">    </span><span class="o">[</span>ITA<span class="o">]=</span>IT
<span class="w">    </span><span class="o">[</span>MACHADINHO<span class="o">]=</span>MC
<span class="w">    </span><span class="o">[</span>SALTO<span class="w"> </span>PILAO<span class="o">]=</span>SP
</pre></div>
</div>
</div>
</section>
<section id="globais-inicializadas-source-src-sync-globals">
<span id="api-sync-globals"></span><h2>Globais inicializadas ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-globals"><span class="std std-ref">Globais inicializadas ([docs]sync-globals)</span></a>)<a class="headerlink" href="#globais-inicializadas-source-src-sync-globals" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Globais inicializadas</span><a class="headerlink" href="#id7" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PROJETO_ESCOLHIDO</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ESTACAO_ESCOLHIDA</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="c1"># IMPORTANTE: manter sempre definido (mesmo que vazio) para não quebrar com set -u</span>
<span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="build-code-pattern-source-src-sync-build-code-pattern">
<span id="api-sync-build-code-pattern"></span><h2>build_code_pattern ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-build-code-pattern"><span class="std std-ref">build_code_pattern ([docs]sync-build-code-pattern)</span></a>)<a class="headerlink" href="#build-code-pattern-source-src-sync-build-code-pattern" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">build_code_pattern</span><a class="headerlink" href="#id8" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build_code_pattern<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span>codes
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>codes<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dc</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">pat</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">pat</span><span class="o">+=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pat</span><span class="p">:+|</span><span class="si">}</span><span class="nv">$c</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;%s&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$pat</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="split-das-codes-source-src-sync-split-das-codes">
<span id="api-sync-split-das-codes"></span><h2>split_das_codes ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-split-das-codes"><span class="std std-ref">split_das_codes ([docs]sync-split-das-codes)</span></a>)<a class="headerlink" href="#split-das-codes-source-src-sync-split-das-codes" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">split_das_codes</span><a class="headerlink" href="#id9" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>split_das_codes<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">dc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>_CODES_SPLIT<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dc</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="log-debug-source-src-sync-log-debug">
<span id="api-sync-log-debug"></span><h2>log_debug ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-log-debug"><span class="std std-ref">log_debug ([docs]sync-log-debug)</span></a>)<a class="headerlink" href="#log-debug-source-src-sync-log-debug" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">log_debug</span><a class="headerlink" href="#id10" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>log_debug<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">VERBOSE</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[DEBUG] </span><span class="nv">$*</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="dia-juliano-source-src-sync-dia-juliano">
<span id="api-sync-dia-juliano"></span><h2>dia_juliano ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-dia-juliano"><span class="std std-ref">dia_juliano ([docs]sync-dia-juliano)</span></a>)<a class="headerlink" href="#dia-juliano-source-src-sync-dia-juliano" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">dia_juliano</span><a class="headerlink" href="#id11" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>dia_juliano<span class="o">()</span><span class="w"> </span><span class="o">{</span><span class="w"> </span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>+%j<span class="p">;</span><span class="w"> </span><span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="is-station-in-list-source-src-sync-is-station-in-list">
<span id="api-sync-is-station-in-list"></span><h2>is_station_in_list ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-is-station-in-list"><span class="std std-ref">is_station_in_list ([docs]sync-is-station-in-list)</span></a>)<a class="headerlink" href="#is-station-in-list-source-src-sync-is-station-in-list" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">is_station_in_list</span><a class="headerlink" href="#id12" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>is_station_in_list<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">station</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>e
<span class="w">    </span><span class="k">for</span><span class="w"> </span>e<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="seleciona-projeto-estacao-source-src-sync-seleciona-projeto">
<span id="api-sync-seleciona-projeto"></span><h2>seleciona_projeto_estacao ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-seleciona-projeto"><span class="std std-ref">seleciona_projeto_estacao ([docs]sync-seleciona-projeto)</span></a>)<a class="headerlink" href="#seleciona-projeto-estacao-source-src-sync-seleciona-projeto" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">seleciona_projeto_estacao</span><a class="headerlink" href="#id13" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>seleciona_projeto_estacao<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Selecione o Projeto e Estação:&quot;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>key<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!projects[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>p<span class="w"> </span>e<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;   %2s) Projeto: %-15s | Estação: %-4s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">read</span><span class="w"> </span>-rp<span class="w"> </span><span class="s1">$&#39;\nDigite o número correspondente: &#39;</span><span class="w"> </span>escolha
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$escolha</span><span class="p">]</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Seleção inválida. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>PROJETO_ESCOLHIDO<span class="w"> </span>ESTACAO_ESCOLHIDA<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$escolha</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_map</span><span class="p">[</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_codes</span><span class="p">[</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># &gt;&gt;&gt; FIX CRÍTICO: code_pattern sempre definido aqui</span>
<span class="w">    </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">reftek_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;reftek&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Reftek.&quot;</span>
<span class="w">    </span><span class="k">elif</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raspberry_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;raspberry&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Raspberry Shake.&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Estação &#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não reconhecida. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="obter-ultimo-sinc-source-src-sync-obter-ultimo-sinc">
<span id="api-sync-obter-ultimo-sinc"></span><h2>obter_ultimo_sinc ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-obter-ultimo-sinc"><span class="std std-ref">obter_ultimo_sinc ([docs]sync-obter-ultimo-sinc)</span></a>)<a class="headerlink" href="#obter-ultimo-sinc-source-src-sync-obter-ultimo-sinc" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">obter_ultimo_sinc</span><a class="headerlink" href="#id14" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>obter_ultimo_sinc<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FORCE_SYNC</span><span class="s2">&quot;</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s1">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">] [FORCE] Sincronização forçada: ignorando último dia na SDS.&quot;</span>
<span class="w">        </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="m">0</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização forçada ativa: definido ultimo_sinc=0&quot;</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>ano_atual
<span class="w">    </span><span class="nv">ano_atual</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%Y<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">tentativas</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ano_atual</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$((</span><span class="nv">ano_atual</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">encontrado</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>ano
<span class="w">    </span><span class="k">for</span><span class="w"> </span>ano<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tentativas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">sds_dir</span><span class="o">=</span><span class="s2">&quot;/SDS/</span><span class="nv">$ano</span><span class="s2">/</span><span class="nv">$project_code</span><span class="s2">/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">/HHZ.D&quot;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>last_file
<span class="w">            </span><span class="nv">last_file</span><span class="o">=</span><span class="k">$(</span>
<span class="w">                </span>ls<span class="w"> </span>-1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="se">\</span>
<span class="w">                  </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1
<span class="w">            </span><span class="k">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nv">encontrado</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ano</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$encontrado</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Não foi possível obter o último dia sincronizado na SDS. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$encontrado</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Último dia sincronizado na SDS (ano </span><span class="nv">$ano_sinc</span><span class="s2">): </span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="prepare-archive-source-src-sync-prepare-archive">
<span id="api-sync-prepare-archive"></span><h2>prepare_archive ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-prepare-archive"><span class="std std-ref">prepare_archive ([docs]sync-prepare-archive)</span></a>)<a class="headerlink" href="#prepare-archive-source-src-sync-prepare-archive" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">prepare_archive</span><a class="headerlink" href="#id15" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>prepare_archive<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="k">in</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_ORIG</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>*.zip.bz2<span class="o">)</span>
<span class="w">            </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">cache_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/_ARCHIVE_CACHE&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cache_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">ARCH_FILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$cache_dir</span><span class="s2">/</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">in</span><span class="p">%.bz2</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>-nt<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Detectado .zip.bz2: descompactando para cache → </span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>bzip2<span class="w"> </span>-dc<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span>rm<span class="w"> </span>-f<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - [ERRO] Falha ao descompactar </span><span class="nv">$in</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>unzip<span class="w"> </span>-tqq<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span>rm<span class="w"> </span>-f<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>
<span class="w">                    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - [ERRO] Cache gerado não é um ZIP válido: </span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">                </span><span class="k">fi</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">            </span><span class="p">;;</span>
<span class="w">        </span>*.zip<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;zip&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*.rar<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;rar&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*.tar<span class="o">)</span><span class="w"> </span><span class="nv">ARCH_KIND</span><span class="o">=</span><span class="s2">&quot;tar&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="list-archive-paths-source-src-sync-list-archive-paths">
<span id="api-sync-list-archive-paths"></span><h2>list_archive_paths ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-list-archive-paths"><span class="std std-ref">list_archive_paths ([docs]sync-list-archive-paths)</span></a>)<a class="headerlink" href="#list-archive-paths-source-src-sync-list-archive-paths" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">list_archive_paths</span><a class="headerlink" href="#id16" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>list_archive_paths<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>zip<span class="o">)</span><span class="w"> </span>unzip<span class="w"> </span>-Z1<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>rar<span class="o">)</span><span class="w"> </span>unrar<span class="w"> </span>lb<span class="w"> </span>-p-<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>tar<span class="o">)</span><span class="w"> </span>tar<span class="w"> </span>-tf<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="extract-dates-from-rasp-source-src-sync-extract-dates-rasp">
<span id="api-sync-extract-dates-rasp"></span><h2>extract_dates_from_rasp ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-extract-dates-rasp"><span class="std std-ref">extract_dates_from_rasp ([docs]sync-extract-dates-rasp)</span></a>)<a class="headerlink" href="#extract-dates-from-rasp-source-src-sync-extract-dates-rasp" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">extract_dates_from_rasp</span><a class="headerlink" href="#id17" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>extract_dates_from_rasp<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">zip_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="w">    </span>unzip<span class="w"> </span>-Z1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;/data/archive/[0-9]{4}/AM/</span><span class="si">${</span><span class="nv">das_code</span><span class="si">}</span><span class="s2">/EH[ZEN]\.D/&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">        year = $(NF-1)</span>
<span class="s1">        jul  = $NF</span>
<span class="s1">        if (year ~ /^[0-9]{4}$/ &amp;&amp; jul ~ /^[0-9]{3}$/) print year jul</span>
<span class="s1">    }&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="extract-reftek-dates-any-depth-source-src-sync-extract-reftek-dates">
<span id="api-sync-extract-reftek-dates"></span><h2>extract_reftek_dates_any_depth ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-extract-reftek-dates"><span class="std std-ref">extract_reftek_dates_any_depth ([docs]sync-extract-reftek-dates)</span></a>)<a class="headerlink" href="#extract-reftek-dates-any-depth-source-src-sync-extract-reftek-dates" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">extract_reftek_dates_any_depth</span><a class="headerlink" href="#id18" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>extract_reftek_dates_any_depth<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">codes_pat</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span><span class="w">   </span><span class="c1"># ex: &quot;9690|AD20&quot;</span>

<span class="w">    </span>list_archive_paths<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">codes</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$codes_pat</span><span class="s2">&quot;</span><span class="w"> </span>-F<span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">        BEGIN {</span>
<span class="s1">            n = split(codes, C, &quot;|&quot;)</span>
<span class="s1">        }</span>
<span class="s1">        function iscode(x){</span>
<span class="s1">            for(i=1;i&lt;=n;i++) if(x==C[i]) return 1</span>
<span class="s1">            return 0</span>
<span class="s1">        }</span>
<span class="s1">        function isdate(x){</span>
<span class="s1">            return (x ~ /^[0-9]{7}([_-].+)?$/)</span>
<span class="s1">        }</span>
<span class="s1">        {</span>
<span class="s1">            if ($1 == &quot;.&quot;) { for (k=1;k&lt;NF;k++) $k=$(k+1); NF=NF-1 }</span>

<span class="s1">            for(i=1; i&lt;=NF-2; i++){</span>
<span class="s1">                if (isdate($i) &amp;&amp; iscode($(i+1)) &amp;&amp; ( $(i+2)==&quot;0&quot; || $(i+2)==&quot;1&quot; )) {</span>
<span class="s1">                    print $i</span>
<span class="s1">                    break</span>
<span class="s1">                }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="encontrar-closest-zip-source-src-sync-encontrar-closest-zip">
<span id="api-sync-encontrar-closest-zip"></span><h2>encontrar_closest_zip ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-encontrar-closest-zip"><span class="std std-ref">encontrar_closest_zip ([docs]sync-encontrar-closest-zip)</span></a>)<a class="headerlink" href="#encontrar-closest-zip-source-src-sync-encontrar-closest-zip" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">encontrar_closest_zip</span><a class="headerlink" href="#id19" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>encontrar_closest_zip<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">best_diff</span><span class="o">=</span><span class="m">999</span>

<span class="w">    </span><span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_code</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] das_code vazio&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">code_pattern</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">code_pattern</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">    </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>arquivo
<span class="w">    </span><span class="k">for</span><span class="w"> </span>arquivo<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$origin_dir</span><span class="s2">&quot;</span>/*<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$arquivo</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>

<span class="w">        </span><span class="nb">echo</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Analisando arquivo: </span><span class="nv">$arquivo</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>prepare_archive<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$arquivo</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extensão não suportada (ou falha ao preparar archive). Pulando.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">kind</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_KIND</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">work_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_FILE</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">raw_datas</span><span class="o">=()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;raspberry&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>mapfile<span class="w"> </span>-t<span class="w"> </span>raw_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>extract_dates_from_rasp<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span>mapfile<span class="w"> </span>-t<span class="w"> </span>raw_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">                </span>extract_reftek_dates_any_depth<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$kind</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="o">)</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">raw_datas</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Pastas internas encontradas (bruto):&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_datas</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Sem pastas internas (YYYYJJJ/DAS/[01]) em </span><span class="nv">$arquivo</span><span class="s2">.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">todas_datas</span><span class="o">=()</span>
<span class="w">        </span>mapfile<span class="w"> </span>-t<span class="w"> </span>todas_datas<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">            </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_datas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/^([0-9]{7}).*$/\1/&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="w">        </span><span class="o">)</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Datas internas puras:&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">todas_datas</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">valid_new_dates</span><span class="o">=()</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>dia
<span class="w">        </span><span class="k">for</span><span class="w"> </span>dia<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">todas_datas</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian</span><span class="o">=</span><span class="si">${</span><span class="nv">dia</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span>
<span class="w">            </span><span class="o">((</span><span class="w"> </span><span class="m">10</span><span class="c1">#$julian &gt;= 10#$ultimo_sinc )) &amp;&amp; valid_new_dates+=(&quot;$dia&quot;)</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">valid_new_dates</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Nenhuma data ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2"> neste arquivo.&quot;</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">first_new</span><span class="o">=</span><span class="si">${</span><span class="nv">valid_new_dates</span><span class="p">[0]</span><span class="si">}</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">last_new</span><span class="o">=</span><span class="si">${</span><span class="nv">valid_new_dates</span><span class="p">[-1]</span><span class="si">}</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">diff</span><span class="o">=</span><span class="k">$((</span><span class="w"> </span><span class="m">10#</span><span class="si">${</span><span class="nv">first_new</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">10#</span><span class="nv">$ultimo_sinc</span><span class="w"> </span><span class="k">))</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Primeiro dia novo ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2">: </span><span class="nv">$first_new</span><span class="s2"> (diff=</span><span class="nv">$diff</span><span class="s2">)&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>diff<span class="w"> </span>&lt;<span class="w"> </span>best_diff<span class="w"> </span><span class="o">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="se">\</span>
<span class="w">           </span><span class="o">((</span><span class="w"> </span><span class="nv">diff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>best_diff<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="m">10</span><span class="c1">#${last_new:4:3} &gt; 10#${last_date:4:3} )); then</span>
<span class="w">            </span><span class="nv">best_diff</span><span class="o">=</span><span class="nv">$diff</span>
<span class="w">            </span><span class="nv">closest_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$work_file</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">closest_zip_orig</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ARCH_ORIG</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">closest_date</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$first_new</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nv">last_date</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_new</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo adequado encontrado (.zip, .rar ou .tar). Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>closest_gregorian
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>last_gregorian
<span class="w">    </span><span class="nv">closest_gregorian</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y-%m-%d<span class="k">)</span>
<span class="w">    </span><span class="nv">last_gregorian</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y-%m-%d<span class="k">)</span>

<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;###############################################&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ ARQUIVO ESCOLHIDO PARA SINCRONIZAÇÃO:&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Arquivo:      </span><span class="nv">$closest_zip</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Primeiro dia: </span><span class="nv">$closest_date</span><span class="s2"> - </span><span class="nv">$closest_gregorian</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;     • Último dia:   </span><span class="nv">$last_date</span><span class="s2"> - </span><span class="nv">$last_gregorian</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;###############################################&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="comparar-parfiles-com-tolerancia-source-src-sync-comparar-parfiles">
<span id="api-sync-comparar-parfiles"></span><h2>comparar_parfiles_com_tolerancia ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-comparar-parfiles"><span class="std std-ref">comparar_parfiles_com_tolerancia ([docs]sync-comparar-parfiles)</span></a>)<a class="headerlink" href="#comparar-parfiles-com-tolerancia-source-src-sync-comparar-parfiles" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">comparar_parfiles_com_tolerancia</span><a class="headerlink" href="#id20" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>comparar_parfiles_com_tolerancia<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">par_template</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">par_expl</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>

<span class="w">    </span>awk<span class="w"> </span>-F<span class="s1">&#39;;&#39;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">      function trim(s){ gsub(/^[ \t]+|[ \t]+$/, &quot;&quot;, s); return s }</span>

<span class="s1">      NR==FNR {</span>
<span class="s1">          if (FNR == 1) { header_expl = $0; next }</span>
<span class="s1">          for (i=1;i&lt;=NF;i++) $i = trim($i)</span>
<span class="s1">          key = $1 &quot;|&quot; $2 &quot;|&quot; $3</span>
<span class="s1">          a_net[key]   = $4</span>
<span class="s1">          a_sta[key]   = $5</span>
<span class="s1">          a_loc[key]   = $6</span>
<span class="s1">          a_chan[key]  = $7</span>
<span class="s1">          a_sr[key]    = $8</span>
<span class="s1">          a_gain[key]  = $9</span>
<span class="s1">          a_itime[key] = $10</span>
<span class="s1">          has_expl[key]= 1</span>
<span class="s1">          next</span>
<span class="s1">      }</span>

<span class="s1">      FNR == 1 {</span>
<span class="s1">          header_tmpl = $0</span>
<span class="s1">          if (header_tmpl != header_expl) {</span>
<span class="s1">              printf(&quot;[ERRO] Cabeçalho do parfile exploratório difere do template.\n&quot;) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              printf(&quot;       template:     %s\n&quot;, header_tmpl)  &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              printf(&quot;       exploratório: %s\n&quot;, header_expl)  &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>
<span class="s1">          next</span>
<span class="s1">      }</span>

<span class="s1">      {</span>
<span class="s1">          for (i=1;i&lt;=NF;i++) $i = trim($i)</span>
<span class="s1">          das     = $1</span>
<span class="s1">          refchan = $2</span>
<span class="s1">          refstrm = $3</span>
<span class="s1">          if (refstrm != 1) next</span>
<span class="s1">          key = das &quot;|&quot; refchan &quot;|&quot; refstrm</span>

<span class="s1">          if (!(key in has_expl)) {</span>
<span class="s1">              printf(&quot;[ERRO] Parfile exploratório não contém linha equivalente para %s|%s|%s\n&quot;,</span>
<span class="s1">                     das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">              next</span>
<span class="s1">          }</span>

<span class="s1">          tmpl_net   = $4</span>
<span class="s1">          tmpl_sta   = $5</span>
<span class="s1">          tmpl_loc   = $6</span>
<span class="s1">          tmpl_chan  = $7</span>
<span class="s1">          tmpl_sr    = $8</span>
<span class="s1">          tmpl_gain  = $9</span>
<span class="s1">          tmpl_itime = $10</span>

<span class="s1">          expl_net   = a_net[key]</span>
<span class="s1">          expl_sta   = a_sta[key]</span>
<span class="s1">          expl_loc   = a_loc[key]</span>
<span class="s1">          expl_chan  = a_chan[key]</span>
<span class="s1">          expl_sr    = a_sr[key]</span>
<span class="s1">          expl_gain  = a_gain[key]</span>
<span class="s1">          expl_itime = a_itime[key]</span>

<span class="s1">          low_tmpl_net = tolower(tmpl_net)</span>
<span class="s1">          low_expl_net = tolower(expl_net)</span>
<span class="s1">          if (!(low_tmpl_net == low_expl_net || low_expl_net == &quot;xx&quot;)) {</span>
<span class="s1">              printf(&quot;[ERRO] NETCODE difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_net, expl_net, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tolower(tmpl_sta) != tolower(expl_sta)) {</span>
<span class="s1">              printf(&quot;[ERRO] STATION difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_sta, expl_sta, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_loc != expl_loc) {</span>
<span class="s1">              printf(&quot;[ERRO] LOCATION difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_loc, expl_loc, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          low_tmpl_chan = tolower(tmpl_chan)</span>
<span class="s1">          low_expl_chan = tolower(expl_chan)</span>
<span class="s1">          chan_ok = 0</span>
<span class="s1">          if (low_tmpl_chan == low_expl_chan) {</span>
<span class="s1">              chan_ok = 1</span>
<span class="s1">          } else if ( (low_tmpl_chan==&quot;hhn&quot; &amp;&amp; low_expl_chan==&quot;hh1&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hh1&quot; &amp;&amp; low_expl_chan==&quot;hhn&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hhe&quot; &amp;&amp; low_expl_chan==&quot;hh2&quot;) ||</span>
<span class="s1">                      (low_tmpl_chan==&quot;hh2&quot; &amp;&amp; low_expl_chan==&quot;hhe&quot;) ) {</span>
<span class="s1">              chan_ok = 1</span>
<span class="s1">          }</span>
<span class="s1">          if (!chan_ok) {</span>
<span class="s1">              printf(&quot;[ERRO] CHANNEL difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_chan, expl_chan, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_sr != expl_sr) {</span>
<span class="s1">              printf(&quot;[ERRO] SAMPLERATE difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_sr, expl_sr, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_gain != expl_gain) {</span>
<span class="s1">              printf(&quot;[ERRO] GAIN difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_gain, expl_gain, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>

<span class="s1">          if (tmpl_itime != expl_itime) {</span>
<span class="s1">              printf(&quot;[ERRO] IMPLEMENT_TIME difere: template=\&quot;%s\&quot; exploratório=\&quot;%s\&quot; (%s|%s|%s)\n&quot;,</span>
<span class="s1">                     tmpl_itime, expl_itime, das, refchan, refstrm) &gt; &quot;/dev/stderr&quot;</span>
<span class="s1">              erro = 1</span>
<span class="s1">          }</span>
<span class="s1">      }</span>

<span class="s1">      END { exit erro }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_expl</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="resumir-auto-substituicoes-parfile-source-src-sync-resumir-parfiles">
<span id="api-sync-resumir-parfiles"></span><h2>resumir_auto_substituicoes_parfile ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-resumir-parfiles"><span class="std std-ref">resumir_auto_substituicoes_parfile ([docs]sync-resumir-parfiles)</span></a>)<a class="headerlink" href="#resumir-auto-substituicoes-parfile-source-src-sync-resumir-parfiles" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">resumir_auto_substituicoes_parfile</span><a class="headerlink" href="#id21" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>resumir_auto_substituicoes_parfile<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">msg_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;Invalid network code (netcode&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span><span class="o">&amp;&amp;</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;Invalid channel name found&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • Substituições automáticas detectadas pelo rt2ms (modo exploratório):&quot;</span>

<span class="w">    </span>awk<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    /Invalid network code \(netcode = / {</span>
<span class="s1">        orig = $0</span>
<span class="s1">        net = orig</span>
<span class="s1">        sub(/.*Invalid network code \(netcode = /, &quot;&quot;, net)</span>
<span class="s1">        sub(/\).*/, &quot;&quot;, net)</span>

<span class="s1">        new = orig</span>
<span class="s1">        sub(/.*default one \(/, &quot;&quot;, new)</span>
<span class="s1">        sub(/\).*/, &quot;&quot;, new)</span>

<span class="s1">        printf(&quot;         - NETCODE: \&quot;%s\&quot; → \&quot;%s\&quot;\n&quot;, net, new)</span>
<span class="s1">    }</span>

<span class="s1">    /Invalid channel name found/ {</span>
<span class="s1">        orig = $0</span>
<span class="s1">        oldc = orig</span>
<span class="s1">        sub(/.*Invalid channel name found /, &quot;&quot;, oldc)</span>
<span class="s1">        sub(/\..*/, &quot;&quot;, oldc)</span>

<span class="s1">        newc = orig</span>
<span class="s1">        sub(/.*renaming channel as /, &quot;&quot;, newc)</span>
<span class="s1">        sub(/\..*/, &quot;&quot;, newc)</span>

<span class="s1">        printf(&quot;         - CHANNEL: \&quot;%s\&quot; → \&quot;%s\&quot;\n&quot;, oldc, newc)</span>
<span class="s1">    }</span>
<span class="s1">    &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="find-reftek-dirs-stream1-source-src-sync-find-reftek-dirs-stream1">
<span id="api-sync-find-reftek-dirs-stream1"></span><h2>find_reftek_dirs_stream1 ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-find-reftek-dirs-stream1"><span class="std std-ref">find_reftek_dirs_stream1 ([docs]sync-find-reftek-dirs-stream1)</span></a>)<a class="headerlink" href="#find-reftek-dirs-stream1-source-src-sync-find-reftek-dirs-stream1" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">find_reftek_dirs_stream1</span><a class="headerlink" href="#id22" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find_reftek_dirs_stream1<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">args</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$root</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>first<span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-o<span class="w"> </span><span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
<span class="w">        </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-path<span class="w"> </span><span class="s2">&quot;*/</span><span class="nv">$c</span><span class="s2">/1&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">args</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="find-reftek-files-stream0-source-src-sync-find-reftek-files-stream0">
<span id="api-sync-find-reftek-files-stream0"></span><h2>find_reftek_files_stream0 ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-find-reftek-files-stream0"><span class="std std-ref">find_reftek_files_stream0 ([docs]sync-find-reftek-files-stream0)</span></a>)<a class="headerlink" href="#find-reftek-files-stream0-source-src-sync-find-reftek-files-stream0" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">find_reftek_files_stream0</span><a class="headerlink" href="#id23" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find_reftek_files_stream0<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">root</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">args</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$root</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">1</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>c
<span class="w">    </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">continue</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>first<span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">first</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-o<span class="w"> </span><span class="o">)</span><span class="p">;</span><span class="w"> </span><span class="k">fi</span>
<span class="w">        </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span>-path<span class="w"> </span><span class="s2">&quot;*/</span><span class="nv">$c</span><span class="s2">/0/*&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nv">args</span><span class="o">+=(</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="w"> </span><span class="o">)</span>
<span class="w">    </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">args</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="processar-reftek-source-src-sync-processar-reftek">
<span id="api-sync-processar-reftek"></span><h2>processar_reftek ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-processar-reftek"><span class="std std-ref">processar_reftek ([docs]sync-processar-reftek)</span></a>)<a class="headerlink" href="#processar-reftek-source-src-sync-processar-reftek" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">processar_reftek</span><a class="headerlink" href="#id24" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>processar_reftek<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Iniciando processamento REFTEK para estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_first</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_first</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">julian_last</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="nv">$data</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">binary_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_BINARIES&quot;</span>

<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Criado diretório de binários: </span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Descompactando </span><span class="nv">$closest_zip</span><span class="s2"> → </span><span class="nv">$target_dir</span><span class="s2"> ...&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">ext_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_zip</span><span class="p">##*.</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ext_zip</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ext_zip</span><span class="p">,,</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ext_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">        </span>zip<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-qq<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>rar<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span>run_cmd<span class="w"> </span>unrar<span class="w"> </span>x<span class="w"> </span>-inul<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>tar<span class="o">)</span><span class="w"> </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span>run_cmd<span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">        </span>*<span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Tipo de arquivo &#39;</span><span class="nv">$ext_zip</span><span class="s2">&#39; não suportado.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span><span class="k">esac</span>

<span class="w">    </span><span class="c1"># Descobre dirs DAS_CODE (um ou vários)</span>
<span class="w">    </span>split_das_codes<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">codes</span><span class="o">=(</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">_CODES_SPLIT</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>source_dirs<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">        </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span><span class="se">\(</span><span class="w"> </span><span class="se">\</span>
<span class="w">            </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">$(for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]:</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">printf</span><span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;-o -name %s &quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">done)</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span><span class="se">\)</span>
<span class="w">    </span><span class="o">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">source_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum diretório </span><span class="si">${</span><span class="nv">codes</span><span class="p">[*]</span><span class="si">}</span><span class="s2"> encontrado em </span><span class="nv">$target_dir</span><span class="s2">. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span>get_subrel_yjjj_das<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">src</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">rel</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">src</span><span class="p">#</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/&quot;</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>-a<span class="w"> </span>parts<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rel</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>i<span class="w"> </span>c
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span><span class="w"> </span>i&lt;<span class="si">${#</span><span class="nv">parts</span><span class="p">[@]</span><span class="si">}</span>-1<span class="p">;</span><span class="w"> </span>i++<span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span>^<span class="o">[</span><span class="m">0</span>-9<span class="o">]{</span><span class="m">7</span><span class="o">}([</span>_-<span class="o">]</span>.+<span class="o">)</span>?$<span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span>c<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i+1]</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$c</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%s/%s\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">parts</span><span class="p">[i+1]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">                    </span><span class="k">fi</span>
<span class="w">                </span><span class="k">done</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Movendo apenas a partir de YYYYJJJ/DASCODE/ para o BINARIES...&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>src
<span class="w">    </span><span class="k">for</span><span class="w"> </span>src<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">source_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>subrel
<span class="w">        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nv">subrel</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>get_subrel_yjjj_das<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Não consegui derivar subrel YYYYJJJ/DASCODE a partir de: </span><span class="nv">$src</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">            </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">/</span><span class="nv">$subrel</span><span class="s2">&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--remove-source-files<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span>/<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">/</span><span class="nv">$subrel</span><span class="s2">&quot;</span>/<span class="w"> </span>&gt;/dev/null
<span class="w">        </span>run_cmd<span class="w"> </span>find<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$src</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-empty<span class="w"> </span>-delete
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Todos os diretórios YYYYJJJ/DASCODE foram movidos para BINARIES.&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Verificando integridade horária...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>hour_dirs<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>find_reftek_dirs_stream1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span>hour_dir
<span class="w">    </span><span class="k">for</span><span class="w"> </span>hour_dir<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">hour_dirs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>count_files
<span class="w">        </span><span class="nv">count_files</span><span class="o">=</span><span class="k">$(</span>ls<span class="w"> </span>-A<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hour_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l<span class="k">)</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>raw_day_dir
<span class="w">        </span><span class="nv">raw_day_dir</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>dirname<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$hour_dir</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">day_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raw_day_dir</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">7</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span>count_files<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="m">24</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$day_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">year_first</span><span class="si">}${</span><span class="nv">julian_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$day_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">year_last</span><span class="si">}${</span><span class="nv">julian_last</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • BORDA DE COLETA: </span><span class="nv">$hour_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • ARQUIVOS INCOMPLETOS: </span><span class="nv">$hour_dir</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">fi</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extraindo informações de GPS/BATTERY/TEMP...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>info_files<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span><span class="w"> </span>find_reftek_files_stream0<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">codes</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">info_files</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • [AVISO] Nenhum arquivo */DASCODE/0/* encontrado em </span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>info_file
<span class="w">        </span><span class="k">for</span><span class="w"> </span>info_file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">info_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span>awk<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">                /GPS:/ {</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0; getline;</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0; getline;</span>
<span class="s1">                }</span>
<span class="s1">                /BATTERY VOLTAGE/ {</span>
<span class="s1">                    gsub(/[[:cntrl:]]|SH\$[^ ]*/, &quot;&quot;, $0); print $0;</span>
<span class="s1">                }</span>
<span class="s1">            &#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_file</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_info.log&quot;</span>
<span class="w">        </span><span class="k">done</span>

<span class="w">        </span><span class="nv">info_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_info.log&quot;</span>

<span class="w">        </span>awk<span class="w"> </span><span class="s1">&#39;/GPS: POSITION:/ { print }&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_log</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-t<span class="s1">&#39;:&#39;</span><span class="w"> </span>-k1,1n<span class="w"> </span>-k2,2n<span class="w"> </span>-k3,3n<span class="w"> </span>-k4,4n<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.gps&quot;</span>

<span class="w">        </span>awk<span class="w"> </span><span class="s1">&#39;/BATTERY VOLTAGE/ { print }&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$info_log</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-t<span class="s1">&#39;:&#39;</span><span class="w"> </span>-k1,1n<span class="w"> </span>-k2,2n<span class="w"> </span>-k3,3n<span class="w"> </span>-k4,4n<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.battery&quot;</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • GPS e BATTERY extraídos e ordenados:&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;         - </span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.gps&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;         - </span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.battery&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Convertendo para MSEED (rt2ms_py3) e enviando ao SDS...&quot;</span>

<span class="w">      </span><span class="nv">RT2MS_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/python/rt2ms_py3&quot;</span>
<span class="w">      </span><span class="nv">CF_ROOT</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$binary_dir</span><span class="s2">&quot;</span>

<span class="w">      </span>run_cmd<span class="w"> </span>bash<span class="w"> </span>-lc<span class="w"> </span><span class="s2">&quot;cd &#39;</span><span class="nv">$target_dir</span><span class="s2">&#39; &amp;&amp; PYTHONPATH=&#39;</span><span class="nv">$RT2MS_ROOT</span><span class="s2">&#39; python3 -m rt2ms_py3.rt2ms_py3 -d &#39;</span><span class="nv">$CF_ROOT</span><span class="s2">&#39; -e&quot;</span>

<span class="w">      </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/parfile.txt&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] parfile.txt não foi gerado.&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">      </span><span class="nb">local</span><span class="w"> </span><span class="nv">msg_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/rt2ms.msg&quot;</span>
<span class="w">      </span>resumir_auto_substituicoes_parfile<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$msg_file</span><span class="s2">&quot;</span>

<span class="w">      </span><span class="nv">par_template</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PARFILES_DIR</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_parfile.txt&quot;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • Validando parfile.txt contra template: </span><span class="nv">$par_template</span><span class="s2">&quot;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>comparar_parfiles_com_tolerancia<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$par_template</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/parfile.txt&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="nb">echo</span>
<span class="w">              </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] O parfile gerado (parfile.txt) difere do template padrão fora dos limites permitidos.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">              </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">          </span><span class="k">fi</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">          </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      • [AVISO] Template de parfile não encontrado em </span><span class="nv">$par_template</span><span class="s2">; prosseguindo sem validação.&quot;</span>
<span class="w">      </span><span class="k">fi</span>

<span class="w">      </span><span class="nv">outdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_code</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">.MSEED&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>bash<span class="w"> </span>-lc<span class="w"> </span><span class="s2">&quot;cd &#39;</span><span class="nv">$target_dir</span><span class="s2">&#39; &amp;&amp; PYTHONPATH=&#39;</span><span class="nv">$RT2MS_ROOT</span><span class="s2">&#39; python3 -m rt2ms_py3.rt2ms_py3 -d &#39;</span><span class="nv">$CF_ROOT</span><span class="s2">&#39; -p &#39;</span><span class="nv">$par_template</span><span class="s2">&#39; -o &#39;</span><span class="nv">$outdir</span><span class="s2">&#39;&quot;</span>

<span class="w">      </span><span class="nv">log_r2m_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_r2m.log&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span><span class="s2">&quot;/home/suporte/TMP/SYNC/python/dataselect/dataselect&quot;</span><span class="w"> </span>-Ps<span class="w"> </span>-SDS<span class="w"> </span>sds<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$outdir</span><span class="s2">&quot;</span>/<span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span>/*..HH?.*
<span class="w">      </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Processamento REFTEK concluído.&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="processar-raspberry-source-src-sync-processar-raspberry">
<span id="api-sync-processar-raspberry"></span><h2>processar_raspberry ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-processar-raspberry"><span class="std std-ref">processar_raspberry ([docs]sync-processar-raspberry)</span></a>)<a class="headerlink" href="#processar-raspberry-source-src-sync-processar-raspberry" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">processar_raspberry</span><a class="headerlink" href="#id25" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>processar_raspberry<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">echo</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Iniciando processamento RASPBERRY para estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="nv">$julian_last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="nv">$data</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Listando arquivos no ZIP (</span><span class="nv">$closest_zip</span><span class="s2">) com dia ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2">...&quot;</span>
<span class="w">    </span>mapfile<span class="w"> </span>-t<span class="w"> </span>to_extract<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>
<span class="w">        </span>unzip<span class="w"> </span>-Z1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>awk<span class="w"> </span>-v<span class="w"> </span><span class="nv">das</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="w"> </span>-v<span class="w"> </span><span class="nv">US</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span><span class="w"> </span>-F<span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">            index($0, &quot;/&quot; das &quot;/&quot;) &amp;&amp; match($NF, /[0-9]{4}\.[0-9]{3}$/) {</span>
<span class="s1">                split($NF, partes, &quot;.&quot;);</span>
<span class="s1">                if (partes[2] &gt;= US) print $0</span>
<span class="s1">            }&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u
<span class="w">    </span><span class="o">)</span>

<span class="w">    </span><span class="o">[[</span><span class="w"> </span><span class="si">${#</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo ≥ </span><span class="nv">$ultimo_sinc</span><span class="s2"> encontrado. Abortando.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Extraindo </span><span class="si">${#</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> arquivos para </span><span class="nv">$target_dir</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">MSEED_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_MSEED&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-qq<span class="w"> </span>-j<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">to_extract</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Renomeando canais EH? → HH?...&quot;</span>
<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$MSEED_DIR</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>chan<span class="w"> </span>file
<span class="w">    </span><span class="k">for</span><span class="w"> </span>chan<span class="w"> </span><span class="k">in</span><span class="w"> </span>EHZ<span class="w"> </span>EHN<span class="w"> </span>EHE<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span>*<span class="s2">&quot;</span><span class="nv">$chan</span><span class="s2">&quot;</span>*<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">newchan</span><span class="o">=</span><span class="s2">&quot;HH</span><span class="si">${</span><span class="nv">chan</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">newname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">file</span><span class="p">/.</span><span class="nv">$chan</span><span class="p">/.</span><span class="si">${</span><span class="nv">project_code</span><span class="si">}</span><span class="p">.</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="p">..</span><span class="nv">$newchan</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>msmod<span class="w"> </span>--net<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$project_code</span><span class="s2">&quot;</span><span class="w"> </span>--sta<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span>--loc<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>--chan<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$newchan</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$newname</span><span class="s2">&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>rm<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;      → </span><span class="nv">$file</span><span class="s2"> → </span><span class="nv">$newname</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">done</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Enviando .mseed para SDS&quot;</span>
<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">        </span>run_cmd<span class="w"> </span>dataselect<span class="w"> </span>-Ps<span class="w"> </span>-Sd<span class="w"> </span>-A<span class="w"> </span>sds/%Y/%n/%s/%c.D/%n.%s.%l.%c.D.%Y.%j<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">MSEED_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/*
<span class="w">        </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span><span class="nb">unset</span><span class="w"> </span>-v<span class="w"> </span>log_r2m_file<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Processamento RASPBERRY concluído.&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="finalizar-log-source-src-sync-finalizar-log">
<span id="api-sync-finalizar-log"></span><h2>finalizar_log ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-finalizar-log"><span class="std std-ref">finalizar_log ([docs]sync-finalizar-log)</span></a>)<a class="headerlink" href="#finalizar-log-source-src-sync-finalizar-log" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">finalizar_log</span><a class="headerlink" href="#id26" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>finalizar_log<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>sds_size
<span class="w">        </span><span class="nv">sds_size</span><span class="o">=</span><span class="k">$(</span>du<span class="w"> </span>-sh<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/sds&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;NA&quot;</span><span class="k">)</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">zip_ref</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">closest_zip_orig</span><span class="k">:-</span><span class="nv">$closest_zip</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>md5sum_zip
<span class="w">        </span><span class="nv">md5sum_zip</span><span class="o">=</span><span class="k">$(</span>md5sum<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>zip_size
<span class="w">        </span><span class="nv">zip_size</span><span class="o">=</span><span class="k">$(</span>du<span class="w"> </span>-sh<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ MD5 do </span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$zip_ref</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">: </span><span class="nv">$md5sum_zip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Tamanho do ZIP: </span><span class="nv">$zip_size</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Tamanho do SDS: </span><span class="nv">$sds_size</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span>hora_minuto
<span class="w">        </span><span class="nv">hora_minuto</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>+%H%M<span class="k">)</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">new_log</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">_sync.log&quot;</span>
<span class="w">        </span>run_cmd<span class="w"> </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Log sincronização renomeado para: </span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="c1"># chave de associação: mesmo prefixo do _sync.log</span>
<span class="w">        </span><span class="nb">local</span><span class="w"> </span><span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">        </span><span class="c1"># move RT130_*.log para LOGS/ com o mesmo prefixo</span>
<span class="w">        </span><span class="nb">shopt</span><span class="w"> </span>-s<span class="w"> </span>nullglob
<span class="w">        </span><span class="nb">local</span><span class="w"> </span>-a<span class="w"> </span><span class="nv">rtlogs</span><span class="o">=(</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/LOGS&quot;</span>/RT130_*.log<span class="w"> </span><span class="o">)</span>
<span class="w">        </span><span class="nb">shopt</span><span class="w"> </span>-u<span class="w"> </span>nullglob

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">((</span><span class="w"> </span><span class="si">${#</span><span class="nv">rtlogs</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>&gt;<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">))</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span>rt
<span class="w">            </span><span class="k">for</span><span class="w"> </span>rt<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">rtlogs</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">                </span><span class="nb">local</span><span class="w"> </span><span class="nv">b</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rt</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">                </span>run_cmd<span class="w"> </span>mv<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$rt</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">b</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="k">done</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">log_r2m_file</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_r2m_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">local</span><span class="w"> </span><span class="nv">new_r2m</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">hora_minuto</span><span class="si">}</span><span class="s2">_r2m.log&quot;</span>
<span class="w">            </span>run_cmd<span class="w"> </span>mv<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_r2m_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_r2m</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Log r2m renomeado para: </span><span class="nv">$new_r2m</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="k">fi</span>

<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização concluída em: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$new_log</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[WARN] Arquivo de log &#39;</span><span class="nv">$log_file</span><span class="s2">&#39; não encontrado.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="configuracao-de-log-source-src-sync-config-logging">
<span id="api-sync-config-logging"></span><h2>Configuração de log ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-config-logging"><span class="std std-ref">Configuração de log ([docs]sync-config-logging)</span></a>)<a class="headerlink" href="#configuracao-de-log-source-src-sync-config-logging" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">Configuração de diretórios e log</span><a class="headerlink" href="#id27" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">1</span>
<span class="nv">base_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/TMP/SYNC&quot;</span>
<span class="nv">log_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/LOGS&quot;</span>
<span class="nv">PARFILES_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/PARFILES/&quot;</span>
mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">&quot;</span>
<span class="nv">log_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$log_dir</span><span class="s2">/test.log&quot;</span>
:<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
<span class="nb">exec</span><span class="w"> </span>&gt;<span class="w"> </span>&gt;<span class="o">(</span>tee<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span><span class="o">)</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Sincronização iniciada em: </span><span class="k">$(</span>date<span class="w"> </span><span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$log_file</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="cli-usage-source-src-sync-cli-usage">
<span id="api-sync-cli-usage"></span><h2>CLI usage ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-cli-usage"><span class="std std-ref">CLI usage ([docs]sync-cli-usage)</span></a>)<a class="headerlink" href="#cli-usage-source-src-sync-cli-usage" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">CLI usage</span><a class="headerlink" href="#id28" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>usage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span>cat<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">Uso: $0 [opções]</span>

<span class="s">  -p PROJETO   Nome exato do projeto (por ex: &quot;BAESA ENERCAN&quot;)</span>
<span class="s">  -e ESTAÇÃO   Código da estação (por ex: &quot;BC4&quot;)</span>
<span class="s">  -y ANO       (opcional) Ano para procurar o último sincronizado (YYYY).</span>
<span class="s">               Se omitido, tenta ano atual e ano anterior.</span>
<span class="s">  -f           Força sincronização (ignora último dia na SDS)</span>
<span class="s">  -h           Exibe esta ajuda</span>

<span class="s">Exemplos:</span>
<span class="s">  $0 -p &quot;MACHADINHO&quot; -e &quot;MC9&quot;</span>
<span class="s">  $0 -p &quot;ITA&quot; -e &quot;IT1&quot; -y 2024</span>
<span class="s">  $0</span>
<span class="s">EOF</span>
<span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="cli-getopts-source-src-sync-cli-getopts">
<span id="api-sync-cli-getopts"></span><h2>CLI getopts ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-cli-getopts"><span class="std std-ref">CLI getopts ([docs]sync-cli-getopts)</span></a>)<a class="headerlink" href="#cli-getopts-source-src-sync-cli-getopts" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">CLI getopts</span><a class="headerlink" href="#id29" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="nb">getopts</span><span class="w"> </span><span class="s2">&quot;:p:e:y:hf&quot;</span><span class="w"> </span>opt<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$opt</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>p<span class="o">)</span><span class="w"> </span><span class="nv">PROJETO_ESCOLHIDO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>e<span class="o">)</span><span class="w"> </span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>y<span class="o">)</span><span class="w"> </span><span class="nv">ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>f<span class="o">)</span><span class="w"> </span><span class="nv">FORCE_SYNC</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>h<span class="o">)</span><span class="w"> </span>usage<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span><span class="w"> </span>usage<span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="k">esac</span>
<span class="k">done</span>
<span class="nb">shift</span><span class="w"> </span><span class="k">$((</span><span class="nv">OPTIND</span><span class="w"> </span><span class="o">-</span><span class="m">1</span><span class="k">))</span>
</pre></div>
</div>
</div>
</section>
<section id="selecao-do-contexto-source-src-sync-select-context">
<span id="api-sync-select-context"></span><h2>Seleção do contexto ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-select-context"><span class="std std-ref">Seleção do contexto ([docs]sync-select-context)</span></a>)<a class="headerlink" href="#selecao-do-contexto-source-src-sync-select-context" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">Seleção do contexto</span><a class="headerlink" href="#id30" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">found</span><span class="o">=</span><span class="m">0</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>key<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!projects[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>p<span class="w"> </span>e<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">projects</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$e</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nv">found</span><span class="o">=</span><span class="m">1</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$found</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Combinação PROJETO=&#39;</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="s2">&#39; e ESTAÇÃO=&#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não encontrada.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="nv">project_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">project_map</span><span class="p">[</span><span class="nv">$PROJETO_ESCOLHIDO</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">das_code</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">das_codes</span><span class="p">[</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">origin_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/ZIP/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span>

<span class="w">  </span><span class="c1"># &gt;&gt;&gt; FIX CRÍTICO: code_pattern também no modo -p/-e</span>
<span class="w">  </span><span class="nv">code_pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>build_code_pattern<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$das_code</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$code_pattern</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] code_pattern vazio para das_code=&#39;</span><span class="nv">$das_code</span><span class="s2">&#39;&quot;</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="o">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">reftek_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;reftek&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Reftek.&quot;</span>
<span class="w">  </span><span class="k">elif</span><span class="w"> </span>is_station_in_list<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">raspberry_stations</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nv">station_type</span><span class="o">=</span><span class="s2">&quot;raspberry&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Estação </span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2"> (</span><span class="nv">$das_code</span><span class="s2">) é do tipo Raspberry Shake.&quot;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Estação &#39;</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">&#39; não pertence a nenhuma lista conhecida.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">else</span>
<span class="w">  </span>seleciona_projeto_estacao
<span class="k">fi</span>
</pre></div>
</div>
</div>
</section>
<section id="ano-forcado-source-src-sync-ano-forcado">
<span id="api-sync-ano-forcado"></span><h2>Ano forçado ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-ano-forcado"><span class="std std-ref">Ano forçado ([docs]sync-ano-forcado)</span></a>)<a class="headerlink" href="#ano-forcado-source-src-sync-ano-forcado" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">Ano forçado</span><a class="headerlink" href="#id31" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span>log_debug<span class="w"> </span><span class="s2">&quot;Ano forçado: </span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span><span class="nv">_SHA_ANO_FORCADO</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="k">function</span><span class="w"> </span>obter_ultimo_sinc<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">ano</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$_SHA_ANO_FORCADO</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">sds_dir</span><span class="o">=</span><span class="s2">&quot;/SDS/</span><span class="nv">$ano</span><span class="s2">/</span><span class="nv">$project_code</span><span class="s2">/</span><span class="nv">$ESTACAO_ESCOLHIDA</span><span class="s2">/HHZ.D&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Diretório &#39;</span><span class="nv">$sds_dir</span><span class="s2">&#39; não existe para o ano forçado </span><span class="nv">$ano</span><span class="s2">.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nb">local</span><span class="w"> </span>last_file
<span class="w">    </span><span class="nv">last_file</span><span class="o">=</span><span class="k">$(</span>
<span class="w">        </span>ls<span class="w"> </span>-1<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$sds_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-u<span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n1
<span class="w">    </span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Nenhum arquivo &#39;*.YYYYJJJ&#39; em &#39;</span><span class="nv">$sds_dir</span><span class="s2">&#39;.&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">      </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="nv">ultimo_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$last_file</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">ano_sinc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ano</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ Último dia sincronizado na SDS (</span><span class="nv">$sds_dir</span><span class="s2">): </span><span class="nv">$ultimo_sinc</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
</section>
<section id="selecao-automatica-source-src-sync-auto-selection">
<span id="api-sync-auto-selection"></span><h2>Seleção automática ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-auto-selection"><span class="std std-ref">Seleção automática ([docs]sync-auto-selection)</span></a>)<a class="headerlink" href="#selecao-automatica-source-src-sync-auto-selection" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">Seleção automática</span><a class="headerlink" href="#id32" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>obter_ultimo_sinc
encontrar_closest_zip
</pre></div>
</div>
</div>
</section>
<section id="atalho-reftek-sds-source-src-sync-reftek-shortcut">
<span id="api-sync-reftek-shortcut"></span><h2>Atalho REFTEK /sds ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-reftek-shortcut"><span class="std std-ref">Atalho REFTEK /sds ([docs]sync-reftek-shortcut)</span></a>)<a class="headerlink" href="#atalho-reftek-sds-source-src-sync-reftek-shortcut" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">Atalho REFTEK com SDS</span><a class="headerlink" href="#id33" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Atalho: se ZIP já vier com /sds/ (Reftek), apenas extrai e publica</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;reftek&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">local_year_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">4</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">local_julian_last</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">last_date</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$local_year_last</span><span class="s2">-01-01 +</span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">local_julian_last</span><span class="si">}</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2"> days&quot;</span><span class="w"> </span>+%Y%m%d<span class="k">)</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">target_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$base_dir</span><span class="s2">/</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">  </span><span class="nv">mseed_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">_MSEED&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span>unzip<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;NR&gt;3 &amp;&amp; NF&gt;=4 {print $4}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;/sds/&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;→ ZIP já vem em SDS/MiniSEED; extraindo em </span><span class="nv">$target_dir</span><span class="s2"> e pulando reftek2mseed&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span>
<span class="w">    </span>run_cmd<span class="w"> </span>unzip<span class="w"> </span>-j<span class="w"> </span>-qq<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$closest_zip</span><span class="s2">&quot;</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">/</span><span class="nv">$mseed_dir</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nb">pushd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$target_dir</span><span class="s2">&quot;</span><span class="w"> </span>&gt;/dev/null
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - Dataselect ...&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>dataselect<span class="w"> </span>-Ps<span class="w"> </span>-Sd<span class="w"> </span>-A<span class="w"> </span>sds/%Y/%n/%s/%c.D/%n.%s.%l.%c.D.%Y.%j<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$mseed_dir</span><span class="s2">&quot;</span>/*
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;   - sdsClone.py ...&quot;</span>
<span class="w">      </span>run_cmd<span class="w"> </span>sc3<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/home/suporte/bin/sdsClone.py<span class="w"> </span>-s<span class="w"> </span>sds/<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ESTACAO_ESCOLHIDA</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span><span class="s2">.log&quot;</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;s&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>run_cmd<span class="w"> </span>/home/suporte/bin/workthisout.sh<span class="w"> </span>--nostop
<span class="w">    </span><span class="nb">popd</span><span class="w"> </span>&gt;/dev/null

<span class="w">    </span>finalizar_log
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">fi</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
</section>
<section id="dispatch-final-source-src-sync-dispatch">
<span id="api-sync-dispatch"></span><h2>Dispatch final ([source]<a class="reference internal" href="../_modules/SYNC.sh.html#src-sync-dispatch"><span class="std std-ref">Dispatch final ([docs]sync-dispatch)</span></a>)<a class="headerlink" href="#dispatch-final-source-src-sync-dispatch" title="Link permanente para este cabeçalho">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">Dispatch final</span><a class="headerlink" href="#id34" title="Link Permanente para esse código">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dispatch_processing<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">in</span>
<span class="w">    </span>reftek<span class="o">)</span><span class="w"> </span>processar_reftek<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>raspberry<span class="o">)</span><span class="w"> </span>processar_raspberry<span class="w"> </span><span class="p">;;</span>
<span class="w">    </span>*<span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;[ERRO] Tipo de estação desconhecido: </span><span class="nv">$station_type</span><span class="s2">&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="p">;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
<span class="w">  </span><span class="k">esac</span>
<span class="o">}</span>

dispatch_processing
finalizar_log
<span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../_modules/SYNC.sh.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">SYNC.sh — source</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../visao_geral_do_fluxo.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Visão geral do fluxo (<code class="docutils literal notranslate"><span class="pre">SYNC.sh</span></code>)</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Gabriel Góes Rocha de Lima
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">SYNC.sh — API/Reference</a><ul>
<li><a class="reference internal" href="#modo-estrito-set-euo-pipefail-source-src-sync-strict-mode">Modo estrito (<code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">-euo</span> <span class="pre">pipefail</span></code>) ([source]<span class="xref std std-ref">src-sync-strict-mode</span>)</a></li>
<li><a class="reference internal" href="#run-cmd-source-src-sync-run-cmd">run_cmd ([source]<span class="xref std std-ref">src-sync-run-cmd</span>)</a></li>
<li><a class="reference internal" href="#listas-de-estacoes-source-src-sync-station-lists">Listas de estações ([source]<span class="xref std std-ref">src-sync-station-lists</span>)</a></li>
<li><a class="reference internal" href="#das-codes-source-src-sync-das-codes">das_codes ([source]<span class="xref std std-ref">src-sync-das-codes</span>)</a></li>
<li><a class="reference internal" href="#projects-source-src-sync-projects">projects ([source]<span class="xref std std-ref">src-sync-projects</span>)</a></li>
<li><a class="reference internal" href="#project-map-source-src-sync-project-map">project_map ([source]<span class="xref std std-ref">src-sync-project-map</span>)</a></li>
<li><a class="reference internal" href="#globais-inicializadas-source-src-sync-globals">Globais inicializadas ([source]<span class="xref std std-ref">src-sync-globals</span>)</a></li>
<li><a class="reference internal" href="#build-code-pattern-source-src-sync-build-code-pattern">build_code_pattern ([source]<span class="xref std std-ref">src-sync-build-code-pattern</span>)</a></li>
<li><a class="reference internal" href="#split-das-codes-source-src-sync-split-das-codes">split_das_codes ([source]<span class="xref std std-ref">src-sync-split-das-codes</span>)</a></li>
<li><a class="reference internal" href="#log-debug-source-src-sync-log-debug">log_debug ([source]<span class="xref std std-ref">src-sync-log-debug</span>)</a></li>
<li><a class="reference internal" href="#dia-juliano-source-src-sync-dia-juliano">dia_juliano ([source]<span class="xref std std-ref">src-sync-dia-juliano</span>)</a></li>
<li><a class="reference internal" href="#is-station-in-list-source-src-sync-is-station-in-list">is_station_in_list ([source]<span class="xref std std-ref">src-sync-is-station-in-list</span>)</a></li>
<li><a class="reference internal" href="#seleciona-projeto-estacao-source-src-sync-seleciona-projeto">seleciona_projeto_estacao ([source]<span class="xref std std-ref">src-sync-seleciona-projeto</span>)</a></li>
<li><a class="reference internal" href="#obter-ultimo-sinc-source-src-sync-obter-ultimo-sinc">obter_ultimo_sinc ([source]<span class="xref std std-ref">src-sync-obter-ultimo-sinc</span>)</a></li>
<li><a class="reference internal" href="#prepare-archive-source-src-sync-prepare-archive">prepare_archive ([source]<span class="xref std std-ref">src-sync-prepare-archive</span>)</a></li>
<li><a class="reference internal" href="#list-archive-paths-source-src-sync-list-archive-paths">list_archive_paths ([source]<span class="xref std std-ref">src-sync-list-archive-paths</span>)</a></li>
<li><a class="reference internal" href="#extract-dates-from-rasp-source-src-sync-extract-dates-rasp">extract_dates_from_rasp ([source]<span class="xref std std-ref">src-sync-extract-dates-rasp</span>)</a></li>
<li><a class="reference internal" href="#extract-reftek-dates-any-depth-source-src-sync-extract-reftek-dates">extract_reftek_dates_any_depth ([source]<span class="xref std std-ref">src-sync-extract-reftek-dates</span>)</a></li>
<li><a class="reference internal" href="#encontrar-closest-zip-source-src-sync-encontrar-closest-zip">encontrar_closest_zip ([source]<span class="xref std std-ref">src-sync-encontrar-closest-zip</span>)</a></li>
<li><a class="reference internal" href="#comparar-parfiles-com-tolerancia-source-src-sync-comparar-parfiles">comparar_parfiles_com_tolerancia ([source]<span class="xref std std-ref">src-sync-comparar-parfiles</span>)</a></li>
<li><a class="reference internal" href="#resumir-auto-substituicoes-parfile-source-src-sync-resumir-parfiles">resumir_auto_substituicoes_parfile ([source]<span class="xref std std-ref">src-sync-resumir-parfiles</span>)</a></li>
<li><a class="reference internal" href="#find-reftek-dirs-stream1-source-src-sync-find-reftek-dirs-stream1">find_reftek_dirs_stream1 ([source]<span class="xref std std-ref">src-sync-find-reftek-dirs-stream1</span>)</a></li>
<li><a class="reference internal" href="#find-reftek-files-stream0-source-src-sync-find-reftek-files-stream0">find_reftek_files_stream0 ([source]<span class="xref std std-ref">src-sync-find-reftek-files-stream0</span>)</a></li>
<li><a class="reference internal" href="#processar-reftek-source-src-sync-processar-reftek">processar_reftek ([source]<span class="xref std std-ref">src-sync-processar-reftek</span>)</a></li>
<li><a class="reference internal" href="#processar-raspberry-source-src-sync-processar-raspberry">processar_raspberry ([source]<span class="xref std std-ref">src-sync-processar-raspberry</span>)</a></li>
<li><a class="reference internal" href="#finalizar-log-source-src-sync-finalizar-log">finalizar_log ([source]<span class="xref std std-ref">src-sync-finalizar-log</span>)</a></li>
<li><a class="reference internal" href="#configuracao-de-log-source-src-sync-config-logging">Configuração de log ([source]<span class="xref std std-ref">src-sync-config-logging</span>)</a></li>
<li><a class="reference internal" href="#cli-usage-source-src-sync-cli-usage">CLI usage ([source]<span class="xref std std-ref">src-sync-cli-usage</span>)</a></li>
<li><a class="reference internal" href="#cli-getopts-source-src-sync-cli-getopts">CLI getopts ([source]<span class="xref std std-ref">src-sync-cli-getopts</span>)</a></li>
<li><a class="reference internal" href="#selecao-do-contexto-source-src-sync-select-context">Seleção do contexto ([source]<span class="xref std std-ref">src-sync-select-context</span>)</a></li>
<li><a class="reference internal" href="#ano-forcado-source-src-sync-ano-forcado">Ano forçado ([source]<span class="xref std std-ref">src-sync-ano-forcado</span>)</a></li>
<li><a class="reference internal" href="#selecao-automatica-source-src-sync-auto-selection">Seleção automática ([source]<span class="xref std std-ref">src-sync-auto-selection</span>)</a></li>
<li><a class="reference internal" href="#atalho-reftek-sds-source-src-sync-reftek-shortcut">Atalho REFTEK /sds ([source]<span class="xref std std-ref">src-sync-reftek-shortcut</span>)</a></li>
<li><a class="reference internal" href="#dispatch-final-source-src-sync-dispatch">Dispatch final ([source]<span class="xref std std-ref">src-sync-dispatch</span>)</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/translations.js"></script>
    <script src="../_static/design-tabs.js"></script>
    </body>
</html>